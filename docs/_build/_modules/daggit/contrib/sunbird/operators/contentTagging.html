

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>daggit.contrib.sunbird.operators.contentTagging &mdash; daggit 0.5.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> daggit
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../daggit.html">daggit package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">daggit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
      <li>daggit.contrib.sunbird.operators.contentTagging</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for daggit.contrib.sunbird.operators.contentTagging</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">elasticsearch</span> <span class="k">import</span> <span class="n">Elasticsearch</span>

<span class="kn">from</span> <span class="nn">daggit.core.io.io</span> <span class="k">import</span> <span class="n">Pandas_Dataframe</span><span class="p">,</span> <span class="n">File_Txt</span>
<span class="kn">from</span> <span class="nn">daggit.core.io.io</span> <span class="k">import</span> <span class="n">ReadDaggitTask_Folderpath</span>
<span class="kn">from</span> <span class="nn">daggit.core.io.io</span> <span class="k">import</span> <span class="n">KafkaDispatcher</span><span class="p">,</span> <span class="n">KafkaCLI</span>
<span class="kn">from</span> <span class="nn">daggit.core.base.factory</span> <span class="k">import</span> <span class="n">BaseOperator</span>

<span class="kn">from</span> <span class="nn">..operators.contentTaggingUtils</span> <span class="k">import</span> <span class="n">multimodal_text_enrichment</span>
<span class="kn">from</span> <span class="nn">..operators.contentTaggingUtils</span> <span class="k">import</span> <span class="n">keyword_extraction_parallel</span>
<span class="kn">from</span> <span class="nn">..operators.contentTaggingUtils</span> <span class="k">import</span> <span class="n">get_level_keywords</span>
<span class="kn">from</span> <span class="nn">..operators.contentTaggingUtils</span> <span class="k">import</span> <span class="n">jaccard_with_phrase</span>
<span class="kn">from</span> <span class="nn">..operators.contentTaggingUtils</span> <span class="k">import</span> <span class="n">save_obj</span><span class="p">,</span> <span class="n">load_obj</span><span class="p">,</span> <span class="n">findFiles</span>
<span class="kn">from</span> <span class="nn">..operators.contentTaggingUtils</span> <span class="k">import</span> <span class="n">merge_json</span>
<span class="kn">from</span> <span class="nn">..operators.contentTaggingUtils</span> <span class="k">import</span> <span class="n">strip_word</span><span class="p">,</span> <span class="n">get_words</span>
<span class="kn">from</span> <span class="nn">..operators.contentTaggingUtils</span> <span class="k">import</span> <span class="n">writeTokafka</span>
<span class="kn">from</span> <span class="nn">..operators.contentTaggingUtils</span> <span class="k">import</span> <span class="n">dictionary_merge</span><span class="p">,</span> <span class="n">get_sorted_list</span>
<span class="kn">from</span> <span class="nn">..operators.contentTaggingUtils</span> <span class="k">import</span> <span class="n">custom_listPreProc</span>
<span class="kn">from</span> <span class="nn">..operators.contentTaggingUtils</span> <span class="k">import</span> <span class="n">df_feature_check</span><span class="p">,</span> <span class="n">identify_contentType</span>
<span class="kn">from</span> <span class="nn">..operators.contentTaggingUtils</span> <span class="k">import</span> <span class="n">precision_from_dictionary</span>
<span class="kn">from</span> <span class="nn">..operators.contentTaggingUtils</span> <span class="k">import</span> <span class="n">agg_precision_from_dictionary</span>
<span class="kn">from</span> <span class="nn">..operators.contentTaggingUtils</span> <span class="k">import</span> <span class="n">CustomDateFormater</span><span class="p">,</span> <span class="n">findDate</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="k">import</span> <span class="n">TfidfVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="k">import</span> <span class="n">CountVectorizer</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="k">import</span> <span class="n">cosine_similarity</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">kafka</span> <span class="k">import</span> <span class="n">KafkaProducer</span><span class="p">,</span> <span class="n">KafkaConsumer</span><span class="p">,</span> <span class="n">KafkaClient</span>


<div class="viewcode-block" id="ContentToTextRead"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.ContentToTextRead">[docs]</a><span class="k">class</span> <span class="nc">ContentToTextRead</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;DS_DATA_HOME&quot;</span><span class="p">:</span> <span class="n">ReadDaggitTask_Folderpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;localpathTocontentMeta&quot;</span><span class="p">:</span> <span class="n">ReadDaggitTask_Folderpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s2">&quot;pathTocredentials&quot;</span><span class="p">:</span> <span class="n">ReadDaggitTask_Folderpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;timestamp_folder&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])}</span>

<div class="viewcode-block" id="ContentToTextRead.run"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.ContentToTextRead.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">range_start</span><span class="p">,</span>
            <span class="n">range_end</span><span class="p">,</span>
            <span class="n">num_of_processes</span><span class="p">,</span>
            <span class="n">content_type</span><span class="p">):</span>
        <span class="n">DS_DATA_HOME</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;DS_DATA_HOME&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read_loc</span><span class="p">()</span>
        <span class="n">pathTocredentials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;pathTocredentials&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read_loc</span><span class="p">()</span>
        <span class="n">timestr</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">path_to_timestamp_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DS_DATA_HOME</span><span class="p">,</span> <span class="n">timestr</span><span class="p">)</span>
        <span class="n">content_to_text_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">path_to_timestamp_folder</span><span class="p">,</span> <span class="s2">&quot;content_to_text&quot;</span><span class="p">)</span>
        <span class="c1"># content dump:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">content_to_text_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">content_to_text_path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;content_to_text: &quot;</span><span class="p">,</span> <span class="n">content_to_text_path</span><span class="p">)</span>
        
        <span class="n">contentmeta_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;localpathTocontentMeta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read_loc</span><span class="p">()</span>
        <span class="c1"># move the content meta to timestamp folder[destination folder]</span>
        <span class="c1">#for the time being experiment with copy: change it later.</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">contentmeta_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_timestamp_folder</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">contentmeta_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">moved_contentmeta_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_timestamp_folder</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">contentmeta_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="n">content_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">moved_contentmeta_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;derived_contentType&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">content_meta</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">content_meta</span><span class="p">[</span><span class="s2">&quot;derived_contentType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">for</span> <span class="n">row_ind</span><span class="p">,</span> <span class="n">artifact_url</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">content_meta</span><span class="p">[</span><span class="s2">&quot;artifactUrl&quot;</span><span class="p">]):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">content_meta</span><span class="p">[</span><span class="s2">&quot;derived_contentType&quot;</span><span class="p">][</span><span class="n">row_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">identify_contentType</span><span class="p">(</span><span class="n">artifact_url</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="n">content_meta</span> <span class="o">=</span> <span class="n">content_meta</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">content_meta</span><span class="p">[</span><span class="s1">&#39;derived_contentType&#39;</span><span class="p">])]</span>
        <span class="n">content_meta</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;timestamp_folder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">location_specify</span><span class="p">())</span>
        <span class="n">oldwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">contentMeta_mandatory_fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;artifactUrl&#39;</span><span class="p">,</span>
            <span class="s1">&#39;derived_contentType&#39;</span><span class="p">,</span>
            <span class="s1">&#39;downloadUrl&#39;</span><span class="p">,</span>
            <span class="s1">&#39;gradeLevel&#39;</span><span class="p">,</span>
            <span class="s1">&#39;identifier&#39;</span><span class="p">,</span>
            <span class="s1">&#39;language&#39;</span><span class="p">,</span>
            <span class="s1">&#39;subject&#39;</span><span class="p">,</span>
            <span class="s1">&#39;graph_id&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nodeType&#39;</span><span class="p">,</span>
            <span class="s1">&#39;objectType&#39;</span><span class="p">,</span>
            <span class="s1">&#39;node_id&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">df_feature_check</span><span class="p">(</span><span class="n">content_meta</span><span class="p">,</span> <span class="n">contentMeta_mandatory_fields</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CTT_CONTENT_TO_TEXT_START&quot;</span><span class="p">)</span>
        <span class="c1"># read content meta:</span>
        <span class="k">if</span> <span class="n">content_meta</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>
            <span class="n">content_meta</span> <span class="o">=</span> <span class="n">content_meta</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># check for duplicates in the meta</span>
        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">content_meta</span><span class="p">[</span><span class="n">content_meta</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span>
                <span class="p">[</span><span class="s1">&#39;artifactUrl&#39;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="kc">False</span><span class="p">)][</span><span class="s2">&quot;artifactUrl&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">content_meta</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s2">&quot;artifactUrl&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">content_meta</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># dropna from artifactUrl feature and reset the index:</span>
        <span class="n">content_meta</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;artifactUrl&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">content_meta</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># time the run</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Contents detected in the content meta: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content_meta</span><span class="p">)))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;----Running Content_to_Text for contents from </span><span class="si">{0}</span><span class="s2"> to </span><span class="si">{1}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">range_start</span><span class="p">,</span> <span class="n">range_end</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;time started: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
        <span class="c1"># subset contentMeta:</span>
        <span class="c1"># content_meta = content_meta[content_meta[&quot;derived_contentType&quot;].isin(</span>
        <span class="c1">#     subset_contentMeta_by.split(&quot;, &quot;))]</span>
        <span class="n">content_meta</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">range_start</span> <span class="o">==</span> <span class="s2">&quot;START&quot;</span><span class="p">:</span>
            <span class="n">range_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">range_end</span> <span class="o">==</span> <span class="s2">&quot;END&quot;</span><span class="p">:</span>
            <span class="n">range_end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content_meta</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;CTT_Config: content_meta from </span><span class="si">{0}</span><span class="s2"> to </span><span class="si">{1}</span><span class="s2"> created in: </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">range_start</span><span class="p">,</span> <span class="n">range_end</span><span class="p">,</span> <span class="n">content_to_text_path</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of processes: &quot;</span><span class="p">,</span> <span class="n">num_of_processes</span><span class="p">)</span>

        <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pathTocredentials</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">(</span><span class="n">allow_no_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">pathTocredentials</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">path_to_googlecred</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;google application credentials&#39;</span><span class="p">][</span><span class="s2">&quot;GOOGLE_APPLICATION_CREDENTIALS&quot;</span><span class="p">]</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_googlecred</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cred_json</span><span class="p">:</span>
                        <span class="n">GOOGLE_APPLICATION_CREDENTIALS</span> <span class="o">=</span> <span class="n">cred_json</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Invalid GOOGLE_APPLICATION_CREDENTIALS in config.&quot;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;***Checking for GOOGLE_APPLICATION_CREDENTIALS environment variable&quot;</span><span class="p">)</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Invalid config file&quot;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;***Checking for GOOGLE_APPLICATION_CREDENTIALS environment variable&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">GOOGLE_APPLICATION_CREDENTIALS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;GOOGLE_APPLICATION_CREDENTIALS&#39;</span><span class="p">]</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">GOOGLE_APPLICATION_CREDENTIALS</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">GOOGLE_APPLICATION_CREDENTIALS</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="n">GOOGLE_APPLICATION_CREDENTIALS</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Not a valid google credential&quot;</span><span class="p">)</span> 

        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">multimodal_text_enrichment</span><span class="p">(</span>
                <span class="n">i</span><span class="p">,</span>
                <span class="n">timestr</span><span class="p">,</span>
                <span class="n">content_meta</span><span class="p">,</span>
                <span class="n">content_type</span><span class="p">,</span>
                <span class="n">content_to_text_path</span><span class="p">,</span>
                <span class="n">GOOGLE_APPLICATION_CREDENTIALS</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                <span class="n">range_start</span><span class="p">,</span>
                <span class="n">range_end</span><span class="p">)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">oldwd</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current directory c2t: &quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;timestamp_folder path:&quot;</span><span class="p">,</span> <span class="n">path_to_timestamp_folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;timestamp_folder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path_to_timestamp_folder</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="KeywordExtraction"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.KeywordExtraction">[docs]</a><span class="k">class</span> <span class="nc">KeywordExtraction</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;timestamp_folder&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;pathTocredentials&quot;</span><span class="p">:</span> <span class="n">ReadDaggitTask_Folderpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s2">&quot;categoryLookup&quot;</span><span class="p">:</span> <span class="n">ReadDaggitTask_Folderpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;path_to_contentKeywords&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">}</span>

<div class="viewcode-block" id="KeywordExtraction.run"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.KeywordExtraction.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extract_keywords</span><span class="p">,</span> <span class="n">filter_criteria</span><span class="p">,</span> <span class="n">update_corpus</span><span class="p">,</span> <span class="n">filter_score_val</span><span class="p">,</span> <span class="n">num_keywords</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">extract_keywords</span> <span class="o">==</span> <span class="s2">&quot;tagme&quot;</span> <span class="ow">or</span> <span class="n">extract_keywords</span> <span class="o">==</span> <span class="s2">&quot;text_token&quot;</span>
        <span class="k">assert</span> <span class="n">filter_criteria</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span> <span class="ow">or</span> <span class="n">filter_criteria</span> <span class="o">==</span> <span class="s2">&quot;taxonomy&quot;</span> <span class="ow">or</span> <span class="n">filter_criteria</span> <span class="o">==</span> <span class="s2">&quot;dbpedia&quot;</span>
        <span class="n">pathTocredentials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;pathTocredentials&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read_loc</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***************pathTocredentials: &quot;</span><span class="p">,</span> <span class="n">pathTocredentials</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">(</span><span class="n">allow_no_value</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">pathTocredentials</span><span class="p">)</span>
        <span class="n">cache_cred</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
        <span class="n">cache_cred</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;redis&quot;</span><span class="p">][</span><span class="s2">&quot;host&quot;</span><span class="p">]</span>
        <span class="n">cache_cred</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;redis&quot;</span><span class="p">][</span><span class="s2">&quot;port&quot;</span><span class="p">]</span>
        <span class="n">cache_cred</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;redis&quot;</span><span class="p">][</span><span class="s2">&quot;password&quot;</span><span class="p">]</span>
        
        <span class="n">tagme_cred</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">tagme_cred</span><span class="p">[</span><span class="s1">&#39;gcube_token&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;tagme credentials&#39;</span><span class="p">][</span><span class="s1">&#39;gcube_token&#39;</span><span class="p">]</span>
        <span class="n">tagme_cred</span><span class="p">[</span><span class="s1">&#39;postman_token&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;tagme credentials&#39;</span><span class="p">][</span><span class="s1">&#39;postman_token&#39;</span><span class="p">]</span>                        

        <span class="n">path_to_category_lookup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;categoryLookup&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read_loc</span><span class="p">()</span>
        <span class="n">timestamp_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;timestamp_folder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">timestr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">timestamp_folder</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;****timestamp folder:&quot;</span><span class="p">,</span> <span class="n">timestamp_folder</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;****categorylookup yaml:&quot;</span><span class="p">,</span> <span class="n">path_to_category_lookup</span><span class="p">)</span>
        <span class="n">content_to_text_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timestamp_folder</span><span class="p">,</span> <span class="s2">&quot;content_to_text&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;content_to_text path:&quot;</span><span class="p">,</span> <span class="n">content_to_text_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">content_to_text_path</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No such directory as: &quot;</span><span class="p">,</span> <span class="n">content_to_text_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;------Transcripts to keywords extraction-----&#39;</span><span class="p">)</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">keywordExtraction_partial</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
               <span class="n">keyword_extraction_parallel</span><span class="p">,</span>
               <span class="n">timestr</span><span class="o">=</span><span class="n">timestr</span><span class="p">,</span>
               <span class="n">content_to_text_path</span><span class="o">=</span><span class="n">content_to_text_path</span><span class="p">,</span>
               <span class="n">extract_keywords</span><span class="o">=</span><span class="n">extract_keywords</span><span class="p">,</span>
               <span class="n">filter_criteria</span><span class="o">=</span><span class="n">filter_criteria</span><span class="p">,</span>
               <span class="n">cache_cred</span><span class="o">=</span><span class="n">cache_cred</span><span class="p">,</span>
               <span class="n">path_to_category_lookup</span><span class="o">=</span><span class="n">path_to_category_lookup</span><span class="p">,</span>
               <span class="n">update_corpus</span><span class="o">=</span><span class="n">update_corpus</span><span class="p">,</span>
               <span class="n">filter_score_val</span><span class="o">=</span><span class="n">filter_score_val</span><span class="p">,</span>
               <span class="n">num_keywords</span><span class="o">=</span><span class="n">num_keywords</span><span class="p">,</span>
               <span class="n">tagme_cred</span><span class="o">=</span><span class="n">tagme_cred</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="n">keywordExtraction_partial</span><span class="p">,</span> <span class="p">[</span>
                    <span class="nb">dir</span> <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">content_to_text_path</span><span class="p">)])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;path to content keywords:&quot;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timestamp_folder</span><span class="p">,</span> <span class="s1">&#39;content_to_text&#39;</span><span class="p">))))</span>
            <span class="n">c2t_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timestamp_folder</span><span class="p">,</span> <span class="s1">&#39;content_to_text&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;path_to_contentKeywords&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                <span class="n">c2t_path</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">))</span>

            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="WriteToElasticSearch"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.WriteToElasticSearch">[docs]</a><span class="k">class</span> <span class="nc">WriteToElasticSearch</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;timestamp_folder&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">}</span>

<div class="viewcode-block" id="WriteToElasticSearch.run"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.WriteToElasticSearch.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">timestamp_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;timestamp_folder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">timestr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">timestamp_folder</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">epoch_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestr</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">))</span>
        <span class="n">es_request</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://localhost:9200&#39;</span><span class="p">)</span>
        <span class="n">content_to_textpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timestamp_folder</span><span class="p">,</span> <span class="s2">&quot;content_to_text&quot;</span><span class="p">)</span>
        <span class="n">cid_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">content_to_textpath</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.DS_Store&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">cid_name</span><span class="p">:</span>
            <span class="n">merge_json_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">json_file</span> <span class="o">=</span> <span class="n">findFiles</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content_to_textpath</span><span class="p">,</span> <span class="n">cid</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">])</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;json_files are: &quot;</span><span class="p">,</span> <span class="n">json_file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="s2">&quot;ML_keyword_info.json&quot;</span><span class="p">,</span> <span class="s2">&quot;ML_content_info.json&quot;</span><span class="p">]:</span>
                    <span class="n">merge_json_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">autotagging_json</span> <span class="o">=</span> <span class="n">merge_json</span><span class="p">(</span><span class="n">merge_json_list</span><span class="p">)</span>
            <span class="n">autotagging_json</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;ETS&quot;</span><span class="p">:</span> <span class="n">epoch_time</span><span class="p">})</span>
            <span class="n">elastic_search</span> <span class="o">=</span> <span class="n">Elasticsearch</span><span class="p">(</span>
                <span class="p">[{</span><span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="s1">&#39;es&#39;</span><span class="p">,</span> <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">9200</span><span class="p">}])</span> <span class="c1">#change it to localhost</span>
            <span class="k">if</span> <span class="n">es_request</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">elastic_search</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                    <span class="n">index</span><span class="o">=</span><span class="s2">&quot;auto_tagging&quot;</span><span class="p">,</span>
                    <span class="n">doc_type</span><span class="o">=</span><span class="s1">&#39;content_id_info&#39;</span><span class="p">,</span>
                    <span class="nb">id</span><span class="o">=</span><span class="n">cid</span><span class="p">,</span>
                    <span class="n">body</span><span class="o">=</span><span class="n">autotagging_json</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="WriteToKafkaTopic"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.WriteToKafkaTopic">[docs]</a><span class="k">class</span> <span class="nc">WriteToKafkaTopic</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;path_to_contentKeywords&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;pathTocredentials&quot;</span><span class="p">:</span> <span class="n">ReadDaggitTask_Folderpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">}</span>

<div class="viewcode-block" id="WriteToKafkaTopic.run"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.WriteToKafkaTopic.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write_to_kafkaTopic</span><span class="p">):</span>
        <span class="n">path_to_contentKeywords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;path_to_contentKeywords&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">pathTocredentials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;pathTocredentials&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read_loc</span><span class="p">()</span>
        <span class="n">timestamp_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path_to_contentKeywords</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">timestr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">timestamp_folder</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">epoch_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestr</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">))</span>
        <span class="n">content_to_textpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timestamp_folder</span><span class="p">,</span> <span class="s2">&quot;content_to_text&quot;</span><span class="p">)</span>
        <span class="n">cid_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">content_to_textpath</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.DS_Store&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">cid_name</span><span class="p">:</span>
            <span class="n">merge_json_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">json_file</span> <span class="o">=</span> <span class="n">findFiles</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content_to_textpath</span><span class="p">,</span> <span class="n">cid</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;json&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="s2">&quot;ML_keyword_info.json&quot;</span><span class="p">,</span> <span class="s2">&quot;ML_content_info.json&quot;</span><span class="p">]:</span>
                    <span class="n">merge_json_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">ignore_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ets&quot;</span><span class="p">]</span>
            <span class="n">dict_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">merge_json_list</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">info</span><span class="p">:</span>
                    <span class="n">new_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
                    <span class="p">[</span><span class="n">new_json</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ignore</span><span class="p">)</span> <span class="k">for</span> <span class="n">ignore</span> <span class="ow">in</span> <span class="n">ignore_list</span> <span class="k">if</span> <span class="n">ignore</span> <span class="ow">in</span> <span class="n">new_json</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                <span class="n">dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_json</span><span class="p">)</span>
            <span class="c1"># merge the nested jsons:-</span>
            <span class="n">autotagging_json</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">merge_json</span><span class="p">,</span> <span class="n">dict_list</span><span class="p">)</span>
            <span class="n">autotagging_json</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;ets&quot;</span><span class="p">:</span> <span class="n">epoch_time</span><span class="p">})</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timestamp_folder</span><span class="p">,</span> <span class="s2">&quot;content_to_text&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="s2">&quot;autoTagging_json.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">main_json</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">autotagging_json</span><span class="p">,</span> <span class="n">main_json</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="c1"># writing to kafka topic:-</span>
            <span class="n">kafka_cli</span> <span class="o">=</span> <span class="n">KafkaCLI</span><span class="p">(</span><span class="n">pathTocredentials</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">kafka_cli</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">autotagging_json</span><span class="p">,</span> <span class="n">write_to_kafkaTopic</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;******Transaction event successfully pushed to topic:</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">write_to_kafkaTopic</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;******Error pushing the event&quot;</span><span class="p">)</span>
        <span class="c1"># Remove the timestamp folder:-</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">timestamp_folder</span><span class="p">)</span></div></div>

            
<div class="viewcode-block" id="CorpusCreation"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.CorpusCreation">[docs]</a><span class="k">class</span> <span class="nc">CorpusCreation</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pathTotaxonomy&quot;</span><span class="p">:</span> <span class="n">Pandas_Dataframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;path_to_contentKeywords&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">}</span>

    <span class="nd">@property</span>  <span class="c1"># how to write to a folder?</span>
    <span class="k">def</span> <span class="nf">outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;root_path&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;path_to_corpus&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">}</span>

<div class="viewcode-block" id="CorpusCreation.run"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.CorpusCreation.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword_folder_name</span><span class="p">,</span> <span class="n">update_corpus</span><span class="p">,</span> <span class="n">word_preprocess</span><span class="p">):</span>
        <span class="n">keyword_folder_ls</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tagme_none&quot;</span><span class="p">,</span> <span class="s2">&quot;txt_token_none&quot;</span><span class="p">,</span> <span class="s2">&quot;tagme_taxonomy&quot;</span><span class="p">,</span> <span class="s2">&quot;tagme_dbpedia&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">keyword_folder_name</span> <span class="ow">in</span> <span class="n">keyword_folder_ls</span><span class="p">:</span>
            <span class="n">taxonomy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;pathTotaxonomy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">path_to_contentKeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;path_to_contentKeywords&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">keyword_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path_to_contentKeys</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">corpus_creation_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keyword_folder</span><span class="p">,</span> <span class="s2">&quot;corpus_creation&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">corpus_creation_folder</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">corpus_creation_folder</span><span class="p">)</span>
            <span class="n">root_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path_to_contentKeys</span><span class="p">)[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">corpus_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s2">&quot;corpus&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">corpus_loc</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">corpus_loc</span><span class="p">)</span>
            <span class="n">corpus_csv_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">corpus_loc</span><span class="p">,</span> <span class="s2">&quot;corpus.csv&quot;</span><span class="p">)</span>
            <span class="n">vocabulary_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">corpus_creation_folder</span><span class="p">,</span> <span class="s2">&quot;vocab&quot;</span><span class="p">)</span>
            <span class="n">cids</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path_to_contentKeys</span><span class="p">)</span>
            <span class="n">content_keywords_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">cids</span><span class="p">:</span>
                <span class="n">path_to_keywords</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">path_to_contentKeys</span><span class="p">,</span>
                    <span class="n">content</span><span class="p">,</span>
                    <span class="s2">&quot;keywords&quot;</span><span class="p">,</span>
                    <span class="n">keyword_folder_name</span><span class="p">,</span>
                    <span class="s2">&quot;keywords.csv&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_keywords</span><span class="p">):</span>
                    <span class="n">extracted_keys</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">extracted_keyword_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                        <span class="n">path_to_keywords</span><span class="p">,</span> <span class="n">keep_default_na</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">extracted_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extracted_keyword_df</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">])</span>
                <span class="n">content_keywords_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extracted_keys</span><span class="p">)</span>
                <span class="c1"># print(&quot;content_keywords_list: &quot;, content_keywords_list)</span>
            <span class="n">content_keywords_list</span> <span class="o">=</span> <span class="n">custom_listPreProc</span><span class="p">(</span>
                <span class="n">content_keywords_list</span><span class="p">,</span>
                <span class="n">word_preprocess</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">],</span>
                <span class="n">word_preprocess</span><span class="p">[</span><span class="s2">&quot;delimitter&quot;</span><span class="p">])</span>
            <span class="n">taxonomy</span><span class="p">[</span><span class="s1">&#39;Keywords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">get_words</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="n">taxonomy</span><span class="p">[</span><span class="s1">&#39;Keywords&#39;</span><span class="p">])]</span>
            <span class="n">taxonomy_keywords</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="n">taxonomy</span><span class="p">[</span><span class="s1">&#39;Keywords&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;nan&#39;</span><span class="p">]</span>
            <span class="n">taxonomy_keywords</span> <span class="o">=</span> <span class="n">custom_listPreProc</span><span class="p">(</span>
                <span class="n">taxonomy_keywords</span><span class="p">,</span>
                <span class="n">word_preprocess</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">],</span>
                <span class="n">word_preprocess</span><span class="p">[</span><span class="s2">&quot;delimitter&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">corpus_csv_loc</span><span class="p">):</span>
                <span class="n">corpus</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">corpus_csv_loc</span><span class="p">)[</span><span class="s1">&#39;Words&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">corpus</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">all_words</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span>
                <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">item1</span> <span class="ow">in</span> <span class="n">taxonomy_keywords</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">item1</span><span class="p">]</span> <span class="o">+</span>
                <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">item2</span> <span class="ow">in</span> <span class="n">content_keywords_list</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">item2</span><span class="p">]</span> <span class="o">+</span>
                <span class="n">corpus</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of unique words: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_words</span><span class="p">))))</span>
            <span class="n">vocabulary</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_words</span><span class="p">)):</span>
                <span class="n">vocabulary</span><span class="p">[</span><span class="n">all_words</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">save_obj</span><span class="p">(</span><span class="n">vocabulary</span><span class="p">,</span> <span class="n">vocabulary_loc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">update_corpus</span><span class="p">:</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;Words&#39;</span><span class="p">:</span> <span class="n">all_words</span><span class="p">})</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">corpus_csv_loc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;root_path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path_to_contentKeys</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;path_to_corpus&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">corpus_creation_folder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; </span><span class="si">{0}</span><span class="s2"> is unknown name&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;keyword_folder_name&quot;</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="ContentTaxonomyScoring"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.ContentTaxonomyScoring">[docs]</a><span class="k">class</span> <span class="nc">ContentTaxonomyScoring</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pathTocontentMeta&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;pathTotaxonomy&quot;</span><span class="p">:</span> <span class="n">Pandas_Dataframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s2">&quot;root_path&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="s2">&quot;path_to_corpus&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

                <span class="p">}</span>

    <span class="nd">@property</span>  <span class="c1"># how to write to a folder?</span>
    <span class="k">def</span> <span class="nf">outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;path_to_timestampFolder&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;path_to_distMeasure&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s2">&quot;path_to_domain_level&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="p">}</span>

<div class="viewcode-block" id="ContentTaxonomyScoring.run"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.ContentTaxonomyScoring.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">keyword_extract_filter_by</span><span class="p">,</span>
            <span class="n">phrase_split</span><span class="p">,</span>
            <span class="n">min_words</span><span class="p">,</span>
            <span class="n">distanceMeasure</span><span class="p">,</span>
            <span class="n">embedding_method</span><span class="p">,</span>
            <span class="n">delimitter</span><span class="p">,</span>
            <span class="n">filter_by</span><span class="p">):</span>
        <span class="n">contentmeta_filterby_column</span> <span class="o">=</span> <span class="n">filter_by</span><span class="p">[</span><span class="s2">&quot;contentMeta&quot;</span><span class="p">][</span><span class="s2">&quot;column&quot;</span><span class="p">]</span>
        <span class="n">contentmeta_level</span> <span class="o">=</span> <span class="n">filter_by</span><span class="p">[</span><span class="s2">&quot;contentMeta&quot;</span><span class="p">][</span><span class="s2">&quot;alignment_depth&quot;</span><span class="p">]</span>
        <span class="n">taxonomy_filterby_column</span> <span class="o">=</span> <span class="n">filter_by</span><span class="p">[</span><span class="s2">&quot;taxonomy&quot;</span><span class="p">][</span><span class="s2">&quot;column&quot;</span><span class="p">]</span>
        <span class="n">taxonomy_level</span> <span class="o">=</span> <span class="n">filter_by</span><span class="p">[</span><span class="s2">&quot;taxonomy&quot;</span><span class="p">][</span><span class="s2">&quot;alignment_depth&quot;</span><span class="p">]</span>
        <span class="n">content_meta_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;pathTocontentMeta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">taxonomy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;pathTotaxonomy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">root_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;root_path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">corpus_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;path_to_corpus&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">content_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">content_meta_loc</span><span class="p">)</span>
        <span class="c1"># check for the presence of corpus folder:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">corpus_folder</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No corpus folder created&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vocab_loc</span> <span class="o">=</span> <span class="n">corpus_folder</span> <span class="o">+</span> <span class="s2">&quot;/vocab&quot;</span>
            <span class="n">vocabulary</span> <span class="o">=</span> <span class="n">load_obj</span><span class="p">(</span><span class="n">vocab_loc</span><span class="p">)</span>
        <span class="n">mapping_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s2">&quot;content_taxonomy_scoring&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mapping_folder</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">mapping_folder</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***mapping folder:&quot;</span><span class="p">,</span> <span class="n">mapping_folder</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">mapping_folder</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mapping_folder</span><span class="p">,</span> <span class="s2">&quot;Run_0&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path_to_subfolders</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">mapping_folder</span><span class="p">,</span>
                    <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">mapping_folder</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">mapping_folder</span><span class="p">,</span>
                        <span class="n">f</span><span class="p">))]</span>
            <span class="n">create_output</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">mapping_folder</span><span class="p">,</span>
                    <span class="s2">&quot;Run_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span>
                <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">path_to_subfolders</span><span class="p">)]</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">create_output</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">create_output</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***output:&quot;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">DELIMITTER</span> <span class="o">=</span> <span class="n">delimitter</span>
        <span class="c1"># cleaning taxonomy KEYWORDS</span>
        <span class="n">taxonomy</span><span class="p">[</span><span class="s1">&#39;Keywords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_words</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">taxonomy</span><span class="p">[</span><span class="s1">&#39;Keywords&#39;</span><span class="p">])]</span>  <span class="c1"># get words from string of words</span>
        <span class="n">taxonomy_keywords</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">taxonomy</span><span class="p">[</span><span class="s1">&#39;Keywords&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;nan&#39;</span><span class="p">]</span>
        <span class="n">taxonomy_keywords</span> <span class="o">=</span> <span class="n">custom_listPreProc</span><span class="p">(</span>
            <span class="n">taxonomy_keywords</span><span class="p">,</span> <span class="s1">&#39;stem_lem&#39;</span><span class="p">,</span> <span class="n">DELIMITTER</span><span class="p">)</span>

        <span class="c1"># print(&quot;****Taxonomy_df keywords****: &quot;, taxonomy[&quot;Keywords&quot;])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Number of Content detected:  &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content_meta</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of content detected:&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">content_meta</span><span class="p">)))</span>

        <span class="n">content_keywords_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;******Content keyword creation for content meta*******&quot;</span><span class="p">)</span>
        <span class="n">path_to_corpus</span> <span class="o">=</span> <span class="n">root_path</span> <span class="o">+</span> <span class="s2">&quot;/content_to_text&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***path_to_corpus: &quot;</span><span class="p">,</span> <span class="n">path_to_corpus</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_corpus</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No such directory as path_to_corpus:&quot;</span><span class="p">,</span> <span class="n">path_to_corpus</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;list of folders in path_to_corpus: &quot;</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path_to_corpus</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">content_meta</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">path_to_corpus</span><span class="p">,</span>
                        <span class="n">content</span><span class="p">,</span>
                        <span class="s2">&quot;keywords&quot;</span><span class="p">,</span>
                        <span class="n">keyword_extract_filter_by</span><span class="p">,</span>
                        <span class="s2">&quot;keywords.csv&quot;</span><span class="p">)):</span>
                    <span class="n">extracted_keys</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">extracted_keyword_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">path_to_corpus</span><span class="p">,</span>
                            <span class="n">content</span><span class="p">,</span>
                            <span class="s2">&quot;keywords&quot;</span><span class="p">,</span>
                            <span class="n">keyword_extract_filter_by</span><span class="p">,</span>
                            <span class="s2">&quot;keywords.csv&quot;</span><span class="p">),</span>
                        <span class="n">keep_default_na</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;keywords </span><span class="si">{0}</span><span class="s2"> for id </span><span class="si">{1}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">list</span><span class="p">(</span>
                                <span class="n">extracted_keyword_df</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]),</span>
                            <span class="n">content</span><span class="p">))</span>
                    <span class="n">extracted_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extracted_keyword_df</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">])</span>
                <span class="n">content_keywords_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extracted_keys</span><span class="p">)</span>
            <span class="n">content_keywords_list</span> <span class="o">=</span> <span class="n">custom_listPreProc</span><span class="p">(</span>
                <span class="n">content_keywords_list</span><span class="p">,</span>
                <span class="s1">&#39;stem_lem&#39;</span><span class="p">,</span>
                <span class="n">DELIMITTER</span><span class="p">)</span>
            <span class="n">content_meta</span><span class="p">[</span><span class="s1">&#39;Content_keywords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content_keywords_list</span>
            <span class="n">content_meta</span> <span class="o">=</span> <span class="n">content_meta</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="n">content_meta</span><span class="p">[</span><span class="s1">&#39;Content_keywords&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">!=</span> <span class="p">[])</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_words</span><span class="p">]]</span>
            <span class="n">content_meta</span> <span class="o">=</span> <span class="n">content_meta</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;contentmeta domains:&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span>
                    <span class="n">content_meta</span><span class="p">[</span><span class="n">contentmeta_filterby_column</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;taxonomy domains:&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">taxonomy</span><span class="p">[</span><span class="n">taxonomy_filterby_column</span><span class="p">]))</span>
            <span class="n">domains</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span>
                <span class="n">content_meta</span><span class="p">[</span><span class="n">contentmeta_filterby_column</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span>
                <span class="n">taxonomy</span><span class="p">[</span><span class="n">taxonomy_filterby_column</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Domains: &quot;</span><span class="p">,</span> <span class="n">domains</span><span class="p">)</span>
            <span class="c1"># empty domain</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">domains</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No Subjects common&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Aggregated on level: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">taxonomy_level</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;------------------------------------------&quot;</span><span class="p">)</span>
            <span class="n">content_meta_sub</span> <span class="o">=</span> <span class="n">content_meta</span><span class="p">[</span><span class="n">contentmeta_filterby_column</span><span class="p">]</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;***Skipping Content id: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                <span class="n">content_meta</span><span class="p">[</span><span class="o">~</span><span class="n">content_meta_sub</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">domains</span><span class="p">)][</span><span class="s1">&#39;identifier&#39;</span><span class="p">])))</span>

            <span class="n">dist_all</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">domain_level_all</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">:</span>
                <span class="n">subject</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running for subject: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subject</span><span class="p">))</span>
                <span class="n">domain_content_df</span> <span class="o">=</span> <span class="n">content_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">content_meta_sub</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                    <span class="n">subject</span><span class="p">)]</span>  <span class="c1"># filter arg: contentmeta column: subject</span>
                <span class="n">domain_content_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">domain_content_df</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]</span>
                <span class="n">tax_sub</span> <span class="o">=</span> <span class="n">taxonomy</span><span class="p">[</span><span class="n">taxonomy_filterby_column</span><span class="p">]</span>
                <span class="n">domain_taxonomy_df</span> <span class="o">=</span> <span class="n">taxonomy</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tax_sub</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                    <span class="n">subject</span><span class="p">)]</span>  <span class="c1"># filter arg: taxonomy column: Subject</span>
                <span class="n">level_domain_taxonomy_df</span> <span class="o">=</span> <span class="n">get_level_keywords</span><span class="p">(</span>
                    <span class="n">domain_taxonomy_df</span><span class="p">,</span> <span class="n">taxonomy_level</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">distanceMeasure</span> <span class="o">==</span> <span class="s1">&#39;jaccard&#39;</span> <span class="ow">or</span> <span class="n">distanceMeasure</span> <span class="o">==</span>
                        <span class="s1">&#39;match_percentage&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">embedding_method</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                    <span class="n">level_domain_taxonomy_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">level_domain_taxonomy_df</span><span class="p">[</span><span class="n">taxonomy_level</span><span class="p">]</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Number of Content in domain: </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">domain_content_df</span><span class="p">))))</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Number of Topic in domain: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">level_domain_taxonomy_df</span><span class="p">))))</span>
                    <span class="n">dist_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">domain_content_df</span><span class="p">),</span>
                             <span class="nb">len</span><span class="p">(</span><span class="n">level_domain_taxonomy_df</span><span class="p">))),</span>
                        <span class="n">index</span><span class="o">=</span><span class="n">domain_content_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                        <span class="n">columns</span><span class="o">=</span><span class="n">level_domain_taxonomy_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">level_domain_taxonomy_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">phrase_split</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="c1"># rewrite the nested for loop:-(optimize the code)</span>
                            <span class="k">for</span> <span class="n">row_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dist_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                <span class="k">for</span> <span class="n">col_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dist_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                                    <span class="n">content_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="n">strip_word</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DELIMITTER</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">domain_content_df</span><span class="p">[</span><span class="s1">&#39;Content_keywords&#39;</span><span class="p">][</span><span class="n">row_ind</span><span class="p">]]</span>
                                    <span class="n">taxonomy_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="n">strip_word</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DELIMITTER</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">level_domain_taxonomy_df</span><span class="p">[</span><span class="s1">&#39;Keywords&#39;</span><span class="p">][</span><span class="n">col_ind</span><span class="p">]]</span>
                                    <span class="n">jaccard_index</span> <span class="o">=</span> <span class="n">jaccard_with_phrase</span><span class="p">(</span>
                                        <span class="n">content_keywords</span><span class="p">,</span> <span class="n">taxonomy_keywords</span><span class="p">)</span>
                                    <span class="n">dist_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row_ind</span><span class="p">,</span>
                                                 <span class="n">col_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">jaccard_index</span><span class="p">[</span><span class="n">distanceMeasure</span><span class="p">]</span>
                                    <span class="n">mapped_df</span> <span class="o">=</span> <span class="n">dist_df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                                        <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                                        <span class="n">get_sorted_list</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                                    <span class="n">mapped_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span>
                                        <span class="mi">1</span><span class="p">,</span> <span class="n">mapped_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">domain_level_all</span><span class="p">[</span><span class="s1">&#39;&amp; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subject</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mapped_df</span>
                            <span class="n">dist_all</span><span class="p">[</span><span class="s1">&#39;&amp; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subject</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dist_df</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">distanceMeasure</span> <span class="o">==</span> <span class="s1">&#39;cosine&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">level_domain_taxonomy_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">taxonomy_documents</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                                <span class="n">level_domain_taxonomy_df</span><span class="p">[</span><span class="s1">&#39;Keywords&#39;</span><span class="p">])]</span>
                        <span class="n">content_documents</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                                <span class="n">domain_content_df</span><span class="p">[</span><span class="s1">&#39;Content_keywords&#39;</span><span class="p">])]</span>
                        <span class="k">if</span> <span class="n">embedding_method</span> <span class="o">==</span> <span class="s1">&#39;tfidf&#39;</span><span class="p">:</span>
                            <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">vocabulary</span><span class="o">=</span><span class="n">vocabulary</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">embedding_method</span> <span class="o">==</span> <span class="s1">&#39;onehot&#39;</span><span class="p">:</span>
                            <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">(</span><span class="n">vocabulary</span><span class="o">=</span><span class="n">vocabulary</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unknown embedding_method&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;selecting default sklearn.CountVectorizer&quot;</span><span class="p">)</span>
                            <span class="n">vectorizer</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">(</span><span class="n">vocabulary</span><span class="o">=</span><span class="n">vocabulary</span><span class="p">)</span>
                        <span class="n">vectorizer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">vocabulary</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                        <span class="n">taxonomy_freq_df</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                            <span class="n">taxonomy_documents</span><span class="p">)</span>
                        <span class="n">taxonomy_freq_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                            <span class="n">taxonomy_freq_df</span><span class="o">.</span><span class="n">todense</span><span class="p">(),</span>
                            <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span>
                                <span class="n">level_domain_taxonomy_df</span><span class="p">[</span><span class="n">taxonomy_level</span><span class="p">]),</span>
                            <span class="n">columns</span><span class="o">=</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">())</span>

                        <span class="n">content_freq_df</span> <span class="o">=</span> <span class="n">vectorizer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                            <span class="n">content_documents</span><span class="p">)</span>
                        <span class="n">content_freq_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">content_freq_df</span><span class="o">.</span><span class="n">todense</span><span class="p">(),</span>
                                                       <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span>
                            <span class="n">domain_content_df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
                            <span class="n">columns</span><span class="o">=</span><span class="n">vectorizer</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">())</span>
                        <span class="n">dist_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                            <span class="n">cosine_similarity</span><span class="p">(</span>
                                <span class="n">content_freq_df</span><span class="p">,</span> <span class="n">taxonomy_freq_df</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span>
                                <span class="n">domain_content_df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span>
                                <span class="n">level_domain_taxonomy_df</span><span class="p">[</span><span class="n">taxonomy_level</span><span class="p">]))</span>
                        <span class="n">mapped_df</span> <span class="o">=</span> <span class="n">dist_df</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                            <span class="n">func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_sorted_list</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
                        <span class="n">mapped_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mapped_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">domain_level_all</span><span class="p">[</span><span class="s1">&#39;&amp; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subject</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mapped_df</span>
                        <span class="n">dist_all</span><span class="p">[</span><span class="s1">&#39;&amp; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subject</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dist_df</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="n">save_obj</span><span class="p">(</span><span class="n">dist_all</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;dist_all&quot;</span><span class="p">))</span>
            <span class="n">save_obj</span><span class="p">(</span>
                <span class="n">domain_level_all</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">output</span><span class="p">,</span>
                    <span class="s2">&quot;domain_level_all&quot;</span><span class="p">))</span>
            <span class="n">cts_output_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;content_taxonomy_scoring&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;distanceMeasure&#39;</span><span class="p">:</span> <span class="n">distanceMeasure</span><span class="p">,</span>
                        <span class="s1">&#39;Common domains for Taxonomy and ContentMeta&#39;</span><span class="p">:</span> <span class="n">domains</span><span class="p">,</span>
                        <span class="s1">&#39;keyword_extract_filter_by&#39;</span><span class="p">:</span> <span class="n">keyword_extract_filter_by</span><span class="p">,</span>
                        <span class="s1">&#39;embedding_method&#39;</span><span class="p">:</span> <span class="n">embedding_method</span><span class="p">,</span>
                        <span class="s1">&#39;filter_taxonomy&#39;</span><span class="p">:</span> <span class="n">taxonomy_filterby_column</span><span class="p">,</span>
                        <span class="s1">&#39;filter_meta&#39;</span><span class="p">:</span> <span class="n">contentmeta_filterby_column</span><span class="p">,</span>
                        <span class="s1">&#39;taxonomy_alignment_depth&#39;</span><span class="p">:</span> <span class="n">taxonomy_level</span><span class="p">,</span>
                        <span class="s1">&#39;content_meta_level&#39;</span><span class="p">:</span> <span class="n">contentmeta_level</span><span class="p">,</span>
                        <span class="s1">&#39;path_to_distanceMeasure&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">output</span><span class="p">,</span>
                            <span class="s2">&quot;dist_all.pkl&quot;</span><span class="p">),</span>
                        <span class="s1">&#39;path_to_domain_level&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">output</span><span class="p">,</span>
                            <span class="s2">&quot;domain_level_all.pkl&quot;</span><span class="p">)}]}</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;ScoringInfo.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">info</span><span class="p">:</span>
                <span class="n">cts_json_dump</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                    <span class="n">cts_output_dict</span><span class="p">,</span>
                    <span class="n">info</span><span class="p">,</span>
                    <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">cts_json_dump</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;path_to_timestampFolder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;path_to_distMeasure&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;dist_all.pkl&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;path_to_domain_level&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;domain_level_all.pkl&quot;</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="PredictTag"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.PredictTag">[docs]</a><span class="k">class</span> <span class="nc">PredictTag</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;path_to_timestampFolder&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">}</span>

    <span class="nd">@property</span>  <span class="c1"># how to write to a folder?</span>
    <span class="k">def</span> <span class="nf">outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;path_to_predictedTags&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">}</span>

<div class="viewcode-block" id="PredictTag.run"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.PredictTag.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>

        <span class="n">timestamp_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;path_to_timestampFolder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PT_START&quot;</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timestamp_folder</span><span class="p">,</span> <span class="s2">&quot;content_taxonomy_scoring&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;output:&quot;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
        <span class="n">prediction_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timestamp_folder</span><span class="p">,</span> <span class="s2">&quot;prediction&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PT_PRED_FOLDER_CREATED: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prediction_folder</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PT_WINDOW: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span> <span class="nb">format</span><span class="p">(</span><span class="n">window</span><span class="p">))</span>
        <span class="n">dist_dict_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">load_obj</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">output</span><span class="p">,</span>
                    <span class="n">path_to_runFolder</span><span class="p">,</span>
                    <span class="s2">&quot;domain_level_all&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">path_to_runFolder</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">output</span><span class="p">,</span>
                    <span class="n">path_to_runFolder</span><span class="p">,</span>
                    <span class="s2">&quot;domain_level_all.pkl&quot;</span><span class="p">))]</span>
        <span class="n">dist_dict</span> <span class="o">=</span> <span class="n">dictionary_merge</span><span class="p">(</span><span class="n">dist_dict_list</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dist_dict:&quot;</span><span class="p">,</span> <span class="n">dist_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dist_dict</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dictionary list is empty. No tags to predict&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">prediction_folder</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">prediction_folder</span><span class="p">)</span>
            <span class="n">pred_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">dist_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pred_df</span> <span class="o">=</span> <span class="n">pred_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist_dict</span><span class="p">[</span><span class="n">domain</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">window</span><span class="p">])</span>
            <span class="n">pred_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">prediction_folder</span><span class="p">,</span>
                    <span class="s2">&quot;predicted_tags.csv&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;path_to_predictedTags&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prediction_folder</span><span class="p">,</span> <span class="s2">&quot;predicted_tags.csv&quot;</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PT_END&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="GenerateObservedTag"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.GenerateObservedTag">[docs]</a><span class="k">class</span> <span class="nc">GenerateObservedTag</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;pathTocontentMeta&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;pathTotaxonomy&quot;</span><span class="p">:</span> <span class="n">Pandas_Dataframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s2">&quot;path_to_timestampFolder&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;path_to_timestampFolder&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;path_to_observedtag&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s2">&quot;path_to_predictedtag&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="p">}</span>

<div class="viewcode-block" id="GenerateObservedTag.getGradedigits"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.GenerateObservedTag.getGradedigits">[docs]</a>    <span class="k">def</span> <span class="nf">getGradedigits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_x</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Class&quot;</span><span class="p">,</span> <span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;Grade&quot;</span><span class="p">,</span> <span class="s2">&quot;grade&quot;</span><span class="p">]:</span>
            <span class="n">class_x</span> <span class="o">=</span> <span class="n">class_x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">class_x</span></div>

<div class="viewcode-block" id="GenerateObservedTag.run"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.GenerateObservedTag.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">tax_known_tag</span><span class="p">,</span> <span class="n">content_known_tag</span><span class="p">):</span>

        <span class="n">content_meta_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;pathTocontentMeta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">content_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">content_meta_loc</span><span class="p">)</span>
        <span class="n">content_meta</span> <span class="o">=</span> <span class="n">content_meta</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">content_meta</span><span class="p">[</span><span class="n">content_known_tag</span><span class="p">])]</span>
        <span class="n">taxonomy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;pathTotaxonomy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">timestamp_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;path_to_timestampFolder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># mapping</span>
        <span class="n">level_mapping</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="n">taxonomy</span><span class="p">[</span><span class="n">tax_known_tag</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span>
                <span class="n">taxonomy</span><span class="p">[</span><span class="n">level</span><span class="p">]))</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">observed_col</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="n">content_meta</span><span class="p">[</span><span class="n">content_known_tag</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span>
                <span class="n">content_meta</span><span class="p">[</span><span class="s1">&#39;identifier&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="c1"># cleaning</span>
        <span class="n">level_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGradedigits</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                             <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">level_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">observed_col</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getGradedigits</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">observed_col</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timestamp_folder</span><span class="p">,</span> <span class="s2">&quot;content_taxonomy_scoring&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Taxonomy mapping not performed&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">observed_tag_output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timestamp_folder</span><span class="p">,</span> <span class="s2">&quot;generate_observed_tags&quot;</span><span class="p">)</span>
            <span class="n">dist_dict_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">load_obj</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">output</span><span class="p">,</span>
                        <span class="n">path_to_runFolder</span><span class="p">,</span>
                        <span class="s2">&quot;domain_level_all&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">path_to_runFolder</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">output</span><span class="p">,</span>
                        <span class="n">path_to_runFolder</span><span class="p">,</span>
                        <span class="s2">&quot;domain_level_all.pkl&quot;</span><span class="p">))]</span>
            <span class="n">predicted_tag</span> <span class="o">=</span> <span class="n">dictionary_merge</span><span class="p">(</span><span class="n">dist_dict_list</span><span class="p">)</span>
            <span class="c1"># check if dist_dict empty or not</span>
            <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">predicted_tag</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No known-tag-discovery to be performed&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">observed_tag_output</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">observed_tag_output</span><span class="p">)</span>
                <span class="c1"># tagging to known values</span>
                <span class="n">observed_tag</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">predicted_tag_known</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">predicted_tag</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">cid</span> <span class="o">=</span> <span class="n">predicted_tag</span><span class="p">[</span><span class="n">domain</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
                    <span class="n">domain_obs_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                        <span class="nb">list</span><span class="p">(</span><span class="n">cid</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">cid</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">tax_known_tag</span><span class="p">])</span>
                    <span class="n">domain_obs_df</span> <span class="o">=</span> <span class="n">domain_obs_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">observed_col</span><span class="p">)</span>
                    <span class="n">observed_tag</span><span class="p">[</span><span class="n">domain</span><span class="p">]</span> <span class="o">=</span> <span class="n">domain_obs_df</span>
                    <span class="n">domain_pred_df</span> <span class="o">=</span> <span class="n">predicted_tag</span><span class="p">[</span><span class="n">domain</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="n">level_mapping</span><span class="p">)</span>
                    <span class="n">predicted_tag_known</span><span class="p">[</span><span class="n">domain</span><span class="p">]</span> <span class="o">=</span> <span class="n">domain_pred_df</span>
                <span class="n">save_obj</span><span class="p">(</span>
                    <span class="n">observed_tag</span><span class="p">,</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">observed_tag_output</span><span class="p">,</span>
                        <span class="s2">&quot;observed_tags&quot;</span><span class="p">))</span>
                <span class="n">save_obj</span><span class="p">(</span>
                    <span class="n">predicted_tag_known</span><span class="p">,</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">observed_tag_output</span><span class="p">,</span>
                        <span class="s2">&quot;predicted_tags&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;path_to_timestampFolder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="n">timestamp_folder</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;path_to_observedtag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">observed_tag_output</span><span class="p">,</span> <span class="s2">&quot;observed_tags.pkl&quot;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;path_to_predictedtag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">observed_tag_output</span><span class="p">,</span> <span class="s2">&quot;predicted_tags.pkl&quot;</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="Evaluation"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.Evaluation">[docs]</a><span class="k">class</span> <span class="nc">Evaluation</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;path_to_timestampFolder&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;path_to_observedtag&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s2">&quot;path_to_predictedtag&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;path_to_agg_precision&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;path_to_nonagg_precision&quot;</span><span class="p">:</span> <span class="n">File_Txt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">}</span>

<div class="viewcode-block" id="Evaluation.run"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTagging.Evaluation.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
        <span class="n">timestamp_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;path_to_timestampFolder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">path_to_observedtag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;path_to_observedtag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">path_to_predictedtag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;path_to_predictedtag&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">timestr</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">observed_tag</span> <span class="o">=</span> <span class="n">load_obj</span><span class="p">(</span><span class="n">path_to_observedtag</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">predicted_tag_known</span> <span class="o">=</span> <span class="n">load_obj</span><span class="p">(</span><span class="n">path_to_predictedtag</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">evaln_output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">timestamp_folder</span><span class="p">)[</span>
                                    <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;evaluation&quot;</span><span class="p">,</span> <span class="n">timestr</span><span class="p">)</span>  <span class="c1"># use os.basepath()</span>

        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">observed_tag</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Observed tag is empty, No evaluation performed&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">evaln_output</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">evaln_output</span><span class="p">)</span>
            <span class="n">eval_dct</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">observed_tag</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pred_df</span> <span class="o">=</span> <span class="n">predicted_tag_known</span><span class="p">[</span><span class="n">items</span><span class="p">]</span>
                <span class="n">observed_df</span> <span class="o">=</span> <span class="n">observed_tag</span><span class="p">[</span><span class="n">items</span><span class="p">]</span>
                <span class="n">eval_dct</span><span class="p">[</span><span class="n">items</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="n">precision_from_dictionary</span><span class="p">(</span>
                        <span class="n">pred_df</span><span class="p">,</span> <span class="n">observed_df</span><span class="p">,</span> <span class="n">window</span><span class="p">)[</span><span class="s1">&#39;percent&#39;</span><span class="p">])</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">eval_dct</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">evaln_output</span><span class="p">,</span> <span class="s2">&quot;non_agg_precision.csv&quot;</span><span class="p">))</span>
            <span class="n">agg_prec_df</span> <span class="o">=</span> <span class="n">agg_precision_from_dictionary</span><span class="p">(</span>
                <span class="n">predicted_tag_known</span><span class="p">,</span> <span class="n">observed_tag</span><span class="p">,</span> <span class="n">window</span><span class="p">)</span>
            <span class="n">agg_prec_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">evaln_output</span><span class="p">,</span> <span class="s2">&quot;agg_precision.csv&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;path_to_agg_precision&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">evaln_output</span><span class="p">,</span> <span class="s2">&quot;agg_precision.csv&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;path_to_nonagg_precision&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">evaln_output</span><span class="p">,</span> <span class="s2">&quot;non_agg_precision.csv&quot;</span><span class="p">))</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Sunbird

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>