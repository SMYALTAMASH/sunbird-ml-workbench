

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>daggit.contrib.sunbird.operators.contentTaggingUtils &mdash; daggit 0.5.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../../index.html" class="icon icon-home"> daggit
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../daggit.html">daggit package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">daggit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../../index.html">Module code</a> &raquo;</li>
        
      <li>daggit.contrib.sunbird.operators.contentTaggingUtils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for daggit.contrib.sunbird.operators.contentTaggingUtils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">nltk</span>
<span class="kn">from</span> <span class="nn">nltk.stem</span> <span class="k">import</span> <span class="n">PorterStemmer</span>
<span class="kn">from</span> <span class="nn">nltk.stem</span> <span class="k">import</span> <span class="n">WordNetLemmatizer</span>
<span class="kn">from</span> <span class="nn">natsort</span> <span class="k">import</span> <span class="n">natsorted</span>
<span class="kn">from</span> <span class="nn">pydub</span> <span class="k">import</span> <span class="n">AudioSegment</span>
<span class="kn">from</span> <span class="nn">google.cloud.vision</span> <span class="k">import</span> <span class="n">types</span>
<span class="kn">from</span> <span class="nn">google.cloud</span> <span class="k">import</span> <span class="n">vision</span>
<span class="kn">from</span> <span class="nn">google.cloud</span> <span class="k">import</span> <span class="n">translate</span>
<span class="kn">from</span> <span class="nn">nltk.corpus</span> <span class="k">import</span> <span class="n">stopwords</span>
<span class="kn">from</span> <span class="nn">pdfminer.pdfinterp</span> <span class="k">import</span> <span class="n">PDFResourceManager</span><span class="p">,</span> <span class="n">PDFPageInterpreter</span>
<span class="kn">from</span> <span class="nn">pdfminer.converter</span> <span class="k">import</span> <span class="n">HTMLConverter</span><span class="p">,</span> <span class="n">TextConverter</span><span class="p">,</span> <span class="n">XMLConverter</span>
<span class="kn">from</span> <span class="nn">pdfminer.layout</span> <span class="k">import</span> <span class="n">LAParams</span>
<span class="kn">from</span> <span class="nn">pdfminer.pdfpage</span> <span class="k">import</span> <span class="n">PDFPage</span>
<span class="kn">from</span> <span class="nn">kafka</span> <span class="k">import</span> <span class="n">KafkaProducer</span><span class="p">,</span> <span class="n">KafkaConsumer</span><span class="p">,</span> <span class="n">KafkaClient</span>

<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">PyPDF2</span> <span class="k">import</span> <span class="n">PdfFileReader</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">ffmpy</span>
<span class="kn">import</span> <span class="nn">speech_recognition</span> <span class="k">as</span> <span class="nn">sr</span>
<span class="kn">import</span> <span class="nn">youtube_dl</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">from</span> <span class="nn">dateutil.parser</span> <span class="k">import</span> <span class="n">parse</span>
<span class="kn">from</span> <span class="nn">SPARQLWrapper</span> <span class="k">import</span> <span class="n">SPARQLWrapper</span><span class="p">,</span> <span class="n">JSON</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;requests&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

<span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;stopwords&quot;</span><span class="p">)</span>
<span class="n">nltk</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;wordnet&quot;</span><span class="p">)</span>
<span class="n">stopwords</span> <span class="o">=</span> <span class="n">stopwords</span><span class="o">.</span><span class="n">words</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">)</span>


<span class="n">pun_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">)</span>


<div class="viewcode-block" id="language_detection"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.language_detection">[docs]</a><span class="k">def</span> <span class="nf">language_detection</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function will take in an enriched text as input and</span>
<span class="sd">    use google translate API to detect language of the text and returns it</span>


<span class="sd">    :param text(str): The text for which the language need to be detected.</span>
<span class="sd">    :returns: The detected language for the given text.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">translate_client</span> <span class="o">=</span> <span class="n">translate</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">translate_client</span><span class="o">.</span><span class="n">detect_language</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="is_date"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.is_date">[docs]</a><span class="k">def</span> <span class="nf">is_date</span><span class="p">(</span><span class="n">date_string</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function  takes a string as an argument and check if the string is a valid date</span>

<span class="sd">    :param date_string(str): A string</span>
<span class="sd">    :returns: A boolean value. True if the string is a valid date and False if otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parse</span><span class="p">(</span><span class="n">date_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="downloadZipFile"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.downloadZipFile">[docs]</a><span class="k">def</span> <span class="nf">downloadZipFile</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Multimedia Content are stored in cloud in ecar or zip format.</span>
<span class="sd">    This function downloads a zip file pointed by url location.</span>
<span class="sd">    The user is expected to have access to the file pointed by url.</span>
<span class="sd">    The extracted file is available in location specified by directory.</span>

<span class="sd">    :param url(str): A valid url pointing to zipped Content location on cloud</span>

<span class="sd">    :returns: Status of download.``True``for uccessful download and ``False`` for unsuccesful download</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
        <span class="n">z</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">ok</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="findFiles"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.findFiles">[docs]</a><span class="k">def</span> <span class="nf">findFiles</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">substrings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Accio!!</span>
<span class="sd">    For a given directory, the function looks for any occurance of a particular</span>
<span class="sd">    file type mentioned by the substrings parameter.</span>

<span class="sd">    :param directory(str): The path to a folder</span>
<span class="sd">    :param substrings(list of strings): An array of extensions to be searched within the directory.</span>
<span class="sd">                                        ``eg: jpg, png, webm, mp4``</span>
<span class="sd">    :returns: List of paths to the detected files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">substrings</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                    <span class="n">string</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">substring</span> <span class="ow">in</span> <span class="n">substrings</span><span class="p">:</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">substring</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">ls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ls</span></div>


<div class="viewcode-block" id="unzip_files"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.unzip_files">[docs]</a><span class="k">def</span> <span class="nf">unzip_files</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function iterates through all the files in a directory and unzip those that are zipped (.zip) to that same folder</span>

<span class="sd">    :param directory(str): A directory or path to a folder</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="n">zip_list</span> <span class="o">=</span> <span class="n">findFiles</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;.zip&#39;</span><span class="p">])</span>
    <span class="n">bugs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">zip_file</span> <span class="ow">in</span> <span class="n">zip_list</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zip_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">z</span><span class="p">:</span>
                <span class="n">z</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">zip_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">bugs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zip_file</span><span class="p">)</span></div>


<div class="viewcode-block" id="ekstep_ecar_unzip"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.ekstep_ecar_unzip">[docs]</a><span class="k">def</span> <span class="nf">ekstep_ecar_unzip</span><span class="p">(</span><span class="n">download_location</span><span class="p">,</span> <span class="n">copy_location</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function unzips an ecar file(ekstep file format)</span>
<span class="sd">    and parses all the subfolder.</span>
<span class="sd">    All the files are copied into one of ``&#39;assets&#39;,&#39;data&#39;,&#39;items&#39;`` folder</span>
<span class="sd">    (same name as in downloaded folder is maintained)</span>
<span class="sd">    based on its location in the downloaded folder.</span>

<span class="sd">    :param download_location(str): A location in the disk where ekstep ecar resource file is downloaded</span>
<span class="sd">    :param copy_location(str): A disk location where the ecar is unwrapped</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">download_location</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">copy_location</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">copy_location</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">copy_location</span><span class="p">)</span>
    <span class="c1">#To make the new sub-directories in which the files will be eventually stored</span>
    <span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">copy_location</span><span class="p">,</span><span class="n">folder</span><span class="p">)</span> <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">,</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="s1">&#39;items&#39;</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">location</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">loc</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
    <span class="n">ecar_extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;gif&#39;</span><span class="p">,</span> <span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;mp4&#39;</span><span class="p">,</span> <span class="s1">&#39;webm&#39;</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="s1">&#39;mp3&#39;</span><span class="p">,</span> <span class="s1">&#39;ecml&#39;</span><span class="p">]</span>
    <span class="n">files_found</span> <span class="o">=</span> <span class="n">findFiles</span><span class="p">(</span><span class="n">download_location</span><span class="p">,</span> <span class="n">ecar_extensions</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">files_found</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files_found</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="ow">in</span> <span class="s2">&quot;ecml&quot;</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">copy_location</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">copy_location</span><span class="p">,</span> <span class="s2">&quot;assets&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No files to copy!&quot;</span><span class="p">)</span>
    <span class="c1"># Delete the messy download directory</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">download_location</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">download_location</span><span class="p">)</span></div>


<div class="viewcode-block" id="download_from_downloadUrl"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.download_from_downloadUrl">[docs]</a><span class="k">def</span> <span class="nf">download_from_downloadUrl</span><span class="p">(</span><span class="n">url_to_download</span><span class="p">,</span> <span class="n">path_to_folder</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
    <span class="n">download_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_folder</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">downloadZipFile</span><span class="p">(</span><span class="n">url_to_download</span><span class="p">,</span> <span class="n">download_dir</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="n">unzip_files</span><span class="p">(</span><span class="n">download_dir</span><span class="p">)</span>
            <span class="n">ekstep_ecar_unzip</span><span class="p">(</span>
                <span class="n">download_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">path_to_folder</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
            <span class="n">path_to_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_folder</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">path_to_file</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unavailable for download&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="df_feature_check"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.df_feature_check">[docs]</a><span class="k">def</span> <span class="nf">df_feature_check</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">mandatory_fields</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if columns are present in the dataframe.</span>

<span class="sd">    :param df(dataframe): DataFrame that needs to be checked</span>
<span class="sd">    :param mandatory_fields(list of strings): List of column names.``eg: jpg, png, webm, mp4``</span>
<span class="sd">    :returns: ``True`` if all columns are present and ``False`` if not all columns are present</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">check</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">if</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">mandatory_fields</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">check</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="cleantext"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.cleantext">[docs]</a><span class="k">def</span> <span class="nf">cleantext</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom function to clean enriched text</span>

<span class="sd">    :param text(str): Enriched ytext from Ekstep Content.</span>
<span class="sd">    :returns: Cleaned text.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">replace_char</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;[&quot;</span><span class="p">,</span>
        <span class="s2">&quot;]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;u&#39;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;None&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Thank you&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="s2">&quot;(&quot;</span><span class="p">,</span>
        <span class="s2">&quot;)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;#&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Done&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="s2">&quot;|&quot;</span><span class="p">,</span>
        <span class="s2">&quot;/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Hint&quot;</span><span class="p">,</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&#39;&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">replace_char</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; +&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span></div>


<div class="viewcode-block" id="clean_text_tokens"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.clean_text_tokens">[docs]</a><span class="k">def</span> <span class="nf">clean_text_tokens</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A custom preprocessor to tokenise and clean a text.</span>
<span class="sd">    Used in Content enrichment pipeline.</span>

<span class="sd">    Process:</span>

<span class="sd">    * tokenise string using nltk word_tokenize()</span>

<span class="sd">    * Remove stopwords</span>

<span class="sd">    * Remove punctuations in words</span>

<span class="sd">    * Remove digits and whitespaces</span>

<span class="sd">    * Convert all words to lowercase</span>

<span class="sd">    * Remove words of length</span>

<span class="sd">    * Remove nan or empty string</span>

<span class="sd">    :param text(str): The string to be tokenised.</span>
<span class="sd">    :returns: List of cleaned tokenised words.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">nltk</span><span class="o">.</span><span class="n">word_tokenize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stopwords</span><span class="p">]</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pun_list</span><span class="p">]</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[0-9\.\W_]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="n">token</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tokens</span></div>


<div class="viewcode-block" id="strip_word"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.strip_word">[docs]</a><span class="k">def</span> <span class="nf">strip_word</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">delimitter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace punctuations from string, punctuation and space in a word</span>
<span class="sd">    with a DELIMITTER</span>

<span class="sd">    :param word(str): Typically a word whose punctuations and space are removed.</span>
<span class="sd">    :param DELIMITTER(str): String to replace punctuations.</span>

<span class="sd">    :returns: Processed string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">delimitters</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;___&quot;</span><span class="p">,</span> <span class="s2">&quot;__&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">]</span> <span class="o">+</span> \
        <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">punctuation</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">lim</span> <span class="ow">in</span> <span class="n">delimitters</span><span class="p">:</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">lim</span><span class="p">,</span> <span class="n">delimitter</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">word</span></div>


<div class="viewcode-block" id="identify_contentType"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.identify_contentType">[docs]</a><span class="k">def</span> <span class="nf">identify_contentType</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a URL for a content, it identifies the type of the content</span>

<span class="sd">    :param url(str): URL</span>

<span class="sd">    :returns: Type of the content</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mp3&#39;</span><span class="p">,</span> <span class="s1">&#39;wav&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;zip&#39;</span><span class="p">,</span> <span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;mp4&#39;</span><span class="p">,</span> <span class="s1">&#39;webm&#39;</span><span class="p">,</span> <span class="s1">&#39;ecar&#39;</span><span class="p">,</span> <span class="s1">&#39;wav&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;youtu.be&#39;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;youtube&#39;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;youtube&quot;</span>
    <span class="k">elif</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;pdf&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;pdf&quot;</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;ecml&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span></div>


<div class="viewcode-block" id="fetch_video_id"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.fetch_video_id">[docs]</a><span class="k">def</span> <span class="nf">fetch_video_id</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a youtube URL and generate video id</span>

<span class="sd">    :param url(str): youtube video URL</span>

<span class="sd">    :returns: Video id of the video URL</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parse_url</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">parse_url</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">query</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="embed_youtube_url_validation"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.embed_youtube_url_validation">[docs]</a><span class="k">def</span> <span class="nf">embed_youtube_url_validation</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a broken youtube URL to custom youtube URL</span>

<span class="sd">    :param url(str): Youtube URL</span>

<span class="sd">    :returns: Custom youtube URL</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">youtube_regex</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;(https?://)?(www\.)?&#39;</span>
        <span class="s1">&#39;(youtube|youtu|youtube-nocookie)\.(com|be)/&#39;</span>
        <span class="s1">&#39;(watch\?v=|embed/|v/|.+\?v=)?([^&amp;=%\?]</span><span class="si">{11}</span><span class="s1">)&#39;</span><span class="p">)</span>

    <span class="n">youtube_regex_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">youtube_regex</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">youtube_regex_match</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">youtube_regex_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;https://www&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;https://www.youtube.com/watch?v=&quot;</span> <span class="o">+</span> \
                <span class="n">fetch_video_id</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;embed/&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])[:</span><span class="mi">11</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;https://www.youtube.com/watch?v=&quot;</span> <span class="o">+</span> \
                <span class="n">youtube_regex_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span></div>


<div class="viewcode-block" id="getImgTags"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.getImgTags">[docs]</a><span class="k">def</span> <span class="nf">getImgTags</span><span class="p">(</span><span class="n">img_file_name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enables to detect text from an image file using Google cloud vision API</span>

<span class="sd">    :param img_file_name(str): Path to an image file</span>

<span class="sd">    :returns: Text detected from the image file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Instantiates a client</span>
    <span class="n">vision_client</span> <span class="o">=</span> <span class="n">vision</span><span class="o">.</span><span class="n">ImageAnnotatorClient</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_file_name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">image_file</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">image_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">vision_client</span><span class="o">.</span><span class="n">text_detection</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">texts</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text_annotations</span>
    <span class="n">full_text</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
        <span class="n">full_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">full_text</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">full_text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">img_dct</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">full_text</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">img_dct</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">img_dct</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="url_to_audio_extraction"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.url_to_audio_extraction">[docs]</a><span class="k">def</span> <span class="nf">url_to_audio_extraction</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download audio in .mp3 format from a youtube URL and save it in a disk location.</span>

<span class="sd">    :param url(str): A youtube URL</span>
<span class="sd">    :returns: Path to the downloaded audio</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;UTAE_YOUTUBE_URL_START: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">cid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">path_to_audio</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cid</span> <span class="o">+</span> <span class="s2">&quot;.mp3&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">path_to_audio</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;UTAE_YOUTUBE_URL_START: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path_to_audio</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">embed_youtube_url_validation</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">ydl_opts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="s1">&#39;bestaudio[asr=44100]/best&#39;</span><span class="p">,</span>
            <span class="s1">&#39;postprocessors&#39;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;FFmpegExtractAudio&#39;</span><span class="p">,</span>
                <span class="s1">&#39;preferredcodec&#39;</span><span class="p">:</span> <span class="s1">&#39;mp3&#39;</span><span class="p">,</span>
                <span class="s1">&#39;preferredquality&#39;</span><span class="p">:</span> <span class="s1">&#39;256&#39;</span>
            <span class="p">}]</span>
        <span class="p">}</span>

        <span class="k">with</span> <span class="n">youtube_dl</span><span class="o">.</span><span class="n">YoutubeDL</span><span class="p">(</span><span class="n">ydl_opts</span><span class="p">)</span> <span class="k">as</span> <span class="n">ydl</span><span class="p">:</span>
            <span class="n">ydl</span><span class="o">.</span><span class="n">download</span><span class="p">([</span><span class="n">url</span><span class="p">])</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span>
                <span class="nb">filter</span><span class="p">(</span>
                    <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;.mp3&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)))[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">path_to_audio</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;UTAE_AUDIO_DOWNLOAD_COMPLETE&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path_to_audio</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">path_to_audio</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;UTAE_YOUTUBE_URL_STOP&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="audio_split"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.audio_split">[docs]</a><span class="k">def</span> <span class="nf">audio_split</span><span class="p">(</span><span class="n">path_to_audiofile</span><span class="p">,</span> <span class="n">path_to_split_audio</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes in an audiofile, split it as per the duration and</span>
<span class="sd">    returns the path to the split</span>

<span class="sd">    :param path_to_audiofile(str): The string is the path to the audio m4a file.</span>
<span class="sd">    :param path_to_split_audio(str): The path to save the audio segmented according to the duration.</span>

<span class="sd">    :returns: Path to audio segment for a given audio file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_split_audio</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_to_split_audio</span><span class="p">)</span>
        <span class="n">split_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path_to_audiofile</span><span class="p">)</span>
        <span class="n">sample_audio</span> <span class="o">=</span> <span class="n">AudioSegment</span><span class="o">.</span><span class="n">from_mp3</span><span class="p">(</span><span class="n">path_to_audiofile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sample_audio</span><span class="o">.</span><span class="n">frame_rate</span> <span class="o">&gt;</span> <span class="mi">16000</span><span class="p">:</span>
            <span class="n">sample_audio</span> <span class="o">=</span> <span class="n">sample_audio</span><span class="o">.</span><span class="n">set_frame_rate</span><span class="p">(</span><span class="mi">16000</span><span class="p">)</span>
        <span class="n">limit_sec</span> <span class="o">=</span> <span class="mi">59</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">no_of_splits</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">sample_audio</span><span class="o">.</span><span class="n">duration_seconds</span> <span class="o">/</span> <span class="mi">59</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">split</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no_of_splits</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">sample_audio</span><span class="p">[</span><span class="n">limit_sec</span> <span class="o">*</span>
                                 <span class="p">(</span><span class="n">split</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="n">limit_sec</span> <span class="o">*</span>
                                             <span class="p">(</span><span class="n">split</span> <span class="o">+</span>
                                              <span class="mi">1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_audio</span><span class="p">))]</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_split_audio</span><span class="p">,</span> <span class="n">split_path</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span>
                             <span class="s2">&quot;/&quot;</span> <span class="o">+</span>
                             <span class="n">split_path</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span>
                                           <span class="mi">4</span><span class="p">]</span> <span class="o">+</span>
                             <span class="s2">&quot;_&quot;</span> <span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s2">&quot;.mp3&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;mp3&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span>
                             <span class="s2">&quot;/&quot;</span> <span class="o">+</span>
                             <span class="n">split_path</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span>
                                           <span class="mi">4</span><span class="p">]</span> <span class="o">+</span>
                             <span class="s2">&quot;_&quot;</span> <span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">+</span>
                             <span class="s2">&quot;.mp3&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;mp3&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;(.*)/assets&#39;</span><span class="p">,</span> <span class="n">path_to_split_audio</span><span class="p">)</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_split_audio</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span></div>


<div class="viewcode-block" id="getTexts"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.getTexts">[docs]</a><span class="k">def</span> <span class="nf">getTexts</span><span class="p">(</span><span class="n">AUDIO_FILE</span><span class="p">,</span> <span class="n">lan</span><span class="p">,</span> <span class="n">GOOGLE_APPLICATION_CREDENTIALS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes in an audiofile and return text of the given audio input</span>

<span class="sd">    :param AUDIO_FILE(str):     path to audio file in mp3 format</span>
<span class="sd">    :param lan(str): This attribute will set the language of the recognition</span>

<span class="sd">    :returns: Recognized text for the audio snippet</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">AUDIO_FILE</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">AudioSegment</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span>
        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.mp3&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">temp</span><span class="p">))</span><span class="o">.</span><span class="n">export</span><span class="p">(</span>
        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.wav&#39;</span> <span class="o">%</span>
        <span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;wav&#39;</span><span class="p">)</span>
    <span class="n">AUDIO_FILE</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.wav&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span>
    <span class="c1"># use the audio file as the audio source</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">sr</span><span class="o">.</span><span class="n">Recognizer</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">sr</span><span class="o">.</span><span class="n">AudioFile</span><span class="p">(</span><span class="n">AUDIO_FILE</span><span class="p">)</span> <span class="k">as</span> <span class="n">source</span><span class="p">:</span>
        <span class="n">audio</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>  <span class="c1"># read the entire audio file</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">audio_text</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recognize_google_cloud</span><span class="p">(</span>
            <span class="n">audio</span><span class="p">,</span>
            <span class="n">credentials_json</span><span class="o">=</span><span class="n">GOOGLE_APPLICATION_CREDENTIALS</span><span class="p">,</span>
            <span class="n">language</span><span class="o">=</span><span class="n">lan</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">sr</span><span class="o">.</span><span class="n">UnknownValueError</span><span class="p">:</span>
        <span class="n">audio_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">except</span> <span class="n">sr</span><span class="o">.</span><span class="n">RequestError</span><span class="p">:</span>
        <span class="n">audio_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">mp3_dct</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">audio_text</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">mp3_dct</span></div>


<div class="viewcode-block" id="translate_english"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.translate_english">[docs]</a><span class="k">def</span> <span class="nf">translate_english</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Translates a given text into target language</span>

<span class="sd">    :param text(str): Text that need to be translated</span>

<span class="sd">    :returns: Text translated into a target language, say:``en(English)``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">translate_client</span> <span class="o">=</span> <span class="n">translate</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;en&#39;</span>
    <span class="n">translation</span> <span class="o">=</span> <span class="n">translate_client</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span>
        <span class="n">text</span><span class="p">,</span> <span class="n">target_language</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">translation</span><span class="p">[</span><span class="s1">&#39;translatedText&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="audio_to_text"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.audio_to_text">[docs]</a><span class="k">def</span> <span class="nf">audio_to_text</span><span class="p">(</span><span class="n">path_to_audio_split_folder</span><span class="p">,</span> <span class="n">GOOGLE_APPLICATION_CREDENTIALS</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function takes in a folder of audios split as per its time duration and convert each audio into text</span>
<span class="sd">    in succession and returns the concatenated texts for a given audio split folder</span>

<span class="sd">    :param path_to_audio_split_folder(str): Path to a folder with the audio splits</span>
<span class="sd">    :param GOOGLE_APPLICATION_CREDENTIALS: Environment variable to designate path to CREDENTIALS json</span>

<span class="sd">    :returns: Concatenated text</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">natsorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path_to_audio_split_folder</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;.mp3&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="n">getTexts</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_audio_split_folder</span><span class="p">,</span>
                                              <span class="n">i</span><span class="p">),</span> <span class="s1">&#39;en-IN&#39;</span><span class="p">,</span> <span class="n">GOOGLE_APPLICATION_CREDENTIALS</span><span class="p">)[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
                <span class="k">continue</span>
    <span class="k">return</span> <span class="n">text</span></div>


<span class="c1"># def text_conversion(path_to_audio_split_folder, path_to_text_folder):</span>
<span class="c1">#     logging.info(&quot;TC_START for audio split folder: {0}&quot;. format(</span>
<span class="c1">#         path_to_audio_split_folder))</span>
<span class="c1">#     if not os.path.exists(path_to_text_folder):</span>
<span class="c1">#         os.mkdir(path_to_text_folder)</span>

<span class="c1">#     path_ = os.path.join(path_to_text_folder, &quot;enriched_text.txt&quot;)</span>
<span class="c1">#     print(&quot;type of audio to text: &quot;, type(</span>
<span class="c1">#         audio_to_text(path_to_audio_split_folder, GOOGLE_APPLICATION_CREDENTIALS)))</span>
<span class="c1">#     with open(path_, &quot;w&quot;) as myTextFile:</span>
<span class="c1">#         myTextFile.write(audio_to_text(path_to_audio_split_folder, GOOGLE_APPLICATION_CREDENTIALS))</span>

<span class="c1">#     logging.info(&quot;TC_TRANSCRIPT_PATH_CREATED: {0}&quot;.format(path_))</span>
<span class="c1">#     logging.info(&quot;TC_STOP for audio split folder: {0}&quot;. format(</span>
<span class="c1">#         path_to_audio_split_folder))</span>
<span class="c1">#     return path_</span>


<div class="viewcode-block" id="getText_json"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.getText_json">[docs]</a><span class="k">def</span> <span class="nf">getText_json</span><span class="p">(</span><span class="n">jdata</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">sdata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">jdata</span><span class="p">)</span>
    <span class="n">text_list</span> <span class="o">=</span> <span class="p">([</span><span class="n">sdata</span><span class="p">[(</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">):</span><span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                  <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;&quot;: &quot;(.*?)&quot;&#39;</span><span class="p">,</span> <span class="n">sdata</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">text_list</span></div>


<div class="viewcode-block" id="download_to_local"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.download_to_local">[docs]</a><span class="k">def</span> <span class="nf">download_to_local</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url_to_download</span><span class="p">,</span> <span class="n">path_to_save</span><span class="p">,</span> <span class="n">id_name</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DTL_START_FOR_URL: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_to_download</span><span class="p">))</span>
    <span class="n">path_to_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;ecml&quot;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DTL_ECAR_URL: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_to_download</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">path_to_id</span> <span class="o">=</span> <span class="n">download_from_downloadUrl</span><span class="p">(</span>
                <span class="n">url_to_download</span><span class="p">,</span> <span class="n">path_to_save</span><span class="p">,</span> <span class="n">id_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipped url: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_to_download</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;youtube&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DTL_YOUTUBE_URL: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_to_download</span><span class="p">))</span>
            <span class="n">path_to_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_save</span><span class="p">,</span> <span class="n">id_name</span><span class="p">)</span>
            <span class="n">location</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_id</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;assets&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">]]</span>

            <span class="n">path_to_audio_download</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_id</span><span class="p">,</span> <span class="s2">&quot;assets&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">location</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">loc</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
            <span class="n">path_to_audio</span> <span class="o">=</span> <span class="n">url_to_audio_extraction</span><span class="p">(</span>
                <span class="n">url_to_download</span><span class="p">,</span> <span class="n">path_to_audio_download</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Path to audio file is </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_to_audio</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Could not download the youtube url&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;pdf&quot;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DTL_PDF_URL: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_to_download</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">path_to_id</span> <span class="o">=</span> <span class="n">download_from_downloadUrl</span><span class="p">(</span>
                <span class="n">url_to_download</span><span class="p">,</span> <span class="n">path_to_save</span><span class="p">,</span> <span class="n">id_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipped url: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_to_download</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Download not required for url: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_to_download</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DTL_STOP_FOR_URL: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url_to_download</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">path_to_id</span></div>


<div class="viewcode-block" id="video_to_speech"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.video_to_speech">[docs]</a><span class="k">def</span> <span class="nf">video_to_speech</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path_to_assets</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;VTS_START&#39;</span><span class="p">)</span>
    <span class="n">video_names</span> <span class="o">=</span> <span class="n">findFiles</span><span class="p">(</span><span class="n">path_to_assets</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mp4&#39;</span><span class="p">,</span> <span class="s1">&#39;webm&#39;</span><span class="p">])</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;...detected </span><span class="si">{0}</span><span class="s1"> video files&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">video_names</span><span class="p">))))</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;ffmpeg&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">video_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VTS_START_FOR_METHOD: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">video_names</span><span class="p">:</span>
            <span class="c1"># ffmpy wrapper to convert mp4 to mp3:</span>
            <span class="k">if</span> <span class="s2">&quot;webm&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">ff</span> <span class="o">=</span> <span class="n">ffmpy</span><span class="o">.</span><span class="n">FFmpeg</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="n">file</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span> <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.mp3&quot;</span><span class="p">):</span> <span class="s1">&#39;-vn -ar 44100 -ac 2 -ab 192 -f mp3&#39;</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="n">ff</span> <span class="o">=</span> <span class="n">ffmpy</span><span class="o">.</span><span class="n">FFmpeg</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">{</span><span class="n">file</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span> <span class="n">outputs</span><span class="o">=</span><span class="p">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.mp3&quot;</span><span class="p">):</span> <span class="s1">&#39;-vn -ar 44100 -ac 2 -ab 192 -f mp3&#39;</span><span class="p">})</span>
            <span class="n">ff</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">path_to_assets</span><span class="p">,</span> <span class="n">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.mp3&quot;</span><span class="p">)):</span>
                <span class="n">path_to_audio</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">path_to_assets</span><span class="p">,</span> <span class="n">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.mp3&quot;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VTS_AUDIO_DOWNLOAD_PATH: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_to_audio</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;mp3 download unsuccessful&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No Video content detected&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;VTS_STOP&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path_to_assets</span></div>


<div class="viewcode-block" id="speech_to_text"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.speech_to_text">[docs]</a><span class="k">def</span> <span class="nf">speech_to_text</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path_to_assets</span><span class="p">,</span> <span class="n">GOOGLE_APPLICATION_CREDENTIALS</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;STT_START&quot;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_assets</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No audio file detected&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">audio_names</span> <span class="o">=</span> <span class="n">findFiles</span><span class="p">(</span><span class="n">path_to_assets</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;mp3&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;googleAT&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">audio_names</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;STT_AUDIO_FILEPATH: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="n">path_to_assets</span><span class="p">,</span> <span class="n">i</span><span class="p">)))</span>
                    <span class="n">path_to_split</span> <span class="o">=</span> <span class="n">audio_split</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">path_to_assets</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">path_to_assets</span><span class="p">,</span> <span class="s2">&quot;audio_split&quot;</span><span class="p">))</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;STT_AUDIO_SPLIT: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_to_split</span><span class="p">))</span>
                    <span class="n">text</span> <span class="o">+=</span> <span class="n">audio_to_text</span><span class="p">(</span><span class="n">path_to_split</span><span class="p">,</span> <span class="n">GOOGLE_APPLICATION_CREDENTIALS</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;STT_NOT_PERFORMED&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unknown method given&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;STT_STOP&quot;</span><span class="p">)</span>
    <span class="n">text_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">text_dict</span></div>


<div class="viewcode-block" id="image_to_text"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.image_to_text">[docs]</a><span class="k">def</span> <span class="nf">image_to_text</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path_to_assets</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ITT_START&quot;</span><span class="p">)</span>
    <span class="n">image_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">image_names</span> <span class="o">=</span> <span class="n">findFiles</span><span class="p">(</span><span class="n">path_to_assets</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="s1">&#39;gif&#39;</span><span class="p">,</span> <span class="s1">&#39;jpg&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;googleVision&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;...detected </span><span class="si">{0}</span><span class="s1"> video files&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image_names</span><span class="p">))))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;...image file processing started&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">image_names</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">image_text</span> <span class="o">+=</span> <span class="n">getImgTags</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;........ Error: could not process file&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Text: &quot;</span><span class="p">,</span> <span class="n">image_text</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">image_text</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
            <span class="n">image_text</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">text</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">image_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ITT_NOT_PERFORMED&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ITT_STOP&quot;</span><span class="p">)</span>
    <span class="n">text_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">image_text</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">text_dict</span></div>


<div class="viewcode-block" id="convert_pdf_to_txt"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.convert_pdf_to_txt">[docs]</a><span class="k">def</span> <span class="nf">convert_pdf_to_txt</span><span class="p">(</span><span class="n">path_to_pdf_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A basic wrapper around PDF miner that parse a PDF file and extracts text from it.</span>

<span class="sd">    :param path_to_pdf_file(str): Path to a PDF file</span>

<span class="sd">    :returns: Text extracted from the PDF file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rsrcmgr</span> <span class="o">=</span> <span class="n">PDFResourceManager</span><span class="p">()</span>
    <span class="n">retstr</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">codec</span> <span class="o">=</span> <span class="s1">&#39;utf-8&#39;</span>
    <span class="n">laparams</span> <span class="o">=</span> <span class="n">LAParams</span><span class="p">()</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">TextConverter</span><span class="p">(</span><span class="n">rsrcmgr</span><span class="p">,</span> <span class="n">retstr</span><span class="p">,</span> <span class="n">codec</span><span class="o">=</span><span class="n">codec</span><span class="p">,</span> <span class="n">laparams</span><span class="o">=</span><span class="n">laparams</span><span class="p">)</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_pdf_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">interpreter</span> <span class="o">=</span> <span class="n">PDFPageInterpreter</span><span class="p">(</span><span class="n">rsrcmgr</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">maxpages</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">caching</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pagenos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">PDFPage</span><span class="o">.</span><span class="n">get_pages</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">pagenos</span><span class="p">,</span> <span class="n">maxpages</span><span class="o">=</span><span class="n">maxpages</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">caching</span><span class="o">=</span><span class="n">caching</span><span class="p">,</span> <span class="n">check_extractable</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">interpreter</span><span class="o">.</span><span class="n">process_page</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">retstr</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">device</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">retstr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">text</span></div>


<div class="viewcode-block" id="pdf_to_text"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.pdf_to_text">[docs]</a><span class="k">def</span> <span class="nf">pdf_to_text</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path_to_assets</span><span class="p">,</span> <span class="n">pdf_url</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">number_of_pages</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PTT_START&quot;</span><span class="p">)</span>
    <span class="n">pdf_names</span> <span class="o">=</span> <span class="n">findFiles</span><span class="p">(</span><span class="n">path_to_assets</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;.pdf&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----&gt;pdf_names: &quot;</span><span class="p">,</span> <span class="n">pdf_names</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;PyPDF2&quot;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PTT_METHOD: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdf_names</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pdf_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pdf_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;pdf&#39;</span><span class="p">)):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf_url</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">read_pdf</span> <span class="o">=</span> <span class="n">PdfFileReader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">number_of_pages</span> <span class="o">=</span> <span class="n">read_pdf</span><span class="o">.</span><span class="n">getNumPages</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pdf_names</span><span class="p">)):</span>
                <span class="n">pdf_files</span> <span class="o">=</span> <span class="n">pdf_names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdf_files</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
                <span class="n">read_pdf</span> <span class="o">=</span> <span class="n">PdfFileReader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">number_of_pages</span> <span class="o">=</span> <span class="n">read_pdf</span><span class="o">.</span><span class="n">getNumPages</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">number_of_pages</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;pdfminer&quot;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PTT_METHOD: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdf_names</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pdf_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pdf_url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;pdf&#39;</span><span class="p">)):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf_url</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="n">read_pdf</span> <span class="o">=</span> <span class="n">PdfFileReader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">number_of_pages</span> <span class="o">=</span> <span class="n">read_pdf</span><span class="o">.</span><span class="n">getNumPages</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pdf_names</span><span class="p">)):</span>
                <span class="n">pdf_files</span> <span class="o">=</span> <span class="n">pdf_names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">convert_pdf_to_txt</span><span class="p">(</span><span class="n">pdf_files</span><span class="p">)</span>
                <span class="n">number_of_pages</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">number_of_pages</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PDF_NOT_PERFORMED&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">number_of_pages</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">number_of_pages</span><span class="p">):</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">read_pdf</span><span class="o">.</span><span class="n">getPage</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">page_content</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">extractText</span><span class="p">()</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="n">page_content</span>
    <span class="n">processed_txt</span> <span class="o">=</span> <span class="n">cleantext</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">processed_txt</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()])</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PTT_STOP&quot;</span><span class="p">)</span>
    <span class="n">text_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span> <span class="s2">&quot;no_of_pages&quot;</span><span class="p">:</span> <span class="n">number_of_pages</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">text_dict</span></div>


<div class="viewcode-block" id="ecml_parser"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.ecml_parser">[docs]</a><span class="k">def</span> <span class="nf">ecml_parser</span><span class="p">(</span><span class="n">ecml_file</span><span class="p">):</span>
    <span class="n">all_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">xmldoc</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ecml_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;htext&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xmldoc</span><span class="o">.</span><span class="n">iter</span><span class="p">()):</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">xmldoc</span><span class="o">.</span><span class="n">iter</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;htext&#39;</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">text</span>
                    <span class="n">all_text</span> <span class="o">+=</span> <span class="n">text</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">plugin_used</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">xmldoc</span><span class="o">.</span><span class="n">iter</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;media&#39;</span><span class="p">]):</span>
            <span class="n">plugin_used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;plugin&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;plugin&#39;</span><span class="p">]):</span>
            <span class="n">plugin_used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="n">plugin_used</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">plugin_used</span><span class="p">))</span>
    <span class="n">num_stages</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xmldoc</span><span class="o">.</span><span class="n">iter</span><span class="p">()]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;stage&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">({</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">all_text</span><span class="p">,</span> <span class="s1">&#39;plugin&#39;</span><span class="p">:</span> <span class="n">plugin_used</span><span class="p">,</span> <span class="s1">&#39;stages&#39;</span><span class="p">:</span> <span class="n">num_stages</span><span class="p">})</span></div>

<div class="viewcode-block" id="modified_ecml_parser"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.modified_ecml_parser">[docs]</a><span class="k">def</span> <span class="nf">modified_ecml_parser</span><span class="p">(</span><span class="n">ecml_file</span><span class="p">):</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ecml_file</span><span class="p">)</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
    <span class="n">tag_to_check</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;org.ekstep.text&#39;</span><span class="p">]</span>
    <span class="n">alltext</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="c1"># create empty list for text items </span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">tag_to_check</span><span class="p">:</span> 
            <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;./stage/&#39;</span><span class="o">+</span><span class="n">i</span><span class="o">.</span><span class="n">tag</span><span class="p">):</span> 
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;config&#39;</span><span class="p">:</span> 
                            <span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\,&quot;</span><span class="p">,</span> <span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                            <span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">8</span><span class="p">][</span><span class="mi">7</span><span class="p">:])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="n">alltext</span><span class="o">+=</span><span class="n">content</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="n">plugin_used</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">num_stages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;media&#39;</span><span class="p">]):</span>
                <span class="n">plugin_used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;plugin&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;plugin&#39;</span><span class="p">]):</span>
                <span class="n">plugin_used</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">plugin_used</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">plugin_used</span><span class="p">))</span>
    <span class="n">num_stages</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">iter</span><span class="p">()]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;stage&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">({</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">alltext</span><span class="p">,</span> <span class="s1">&#39;plugin&#39;</span><span class="p">:</span> <span class="n">plugin_used</span><span class="p">,</span> <span class="s1">&#39;stages&#39;</span><span class="p">:</span> <span class="n">num_stages</span><span class="p">})</span></div>


<div class="viewcode-block" id="ecml_index_to_text"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.ecml_index_to_text">[docs]</a><span class="k">def</span> <span class="nf">ecml_index_to_text</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path_to_id</span><span class="p">):</span>
    <span class="n">all_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">plugin_used</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">num_stages</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ETT_START&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;parse&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_id</span><span class="p">,</span> <span class="s2">&quot;index.ecml&quot;</span><span class="p">)):</span>
            <span class="n">ecml_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_id</span><span class="p">,</span> <span class="s2">&quot;index.ecml&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;...File type detected as ecml&#39;</span><span class="p">)</span>
                <span class="n">ecml_tags</span> <span class="o">=</span> <span class="n">modified_ecml_parser</span><span class="p">(</span><span class="n">ecml_file</span><span class="p">)</span>
                <span class="n">all_text</span> <span class="o">=</span> <span class="n">ecml_tags</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
                <span class="n">plugin_used</span> <span class="o">=</span> <span class="n">ecml_tags</span><span class="p">[</span><span class="s1">&#39;plugin&#39;</span><span class="p">]</span>
                <span class="n">num_stages</span> <span class="o">=</span> <span class="n">ecml_tags</span><span class="p">[</span><span class="s1">&#39;stages&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ecml_text cannot be extracted&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_id</span><span class="p">,</span> <span class="s2">&quot;manifest.json&quot;</span><span class="p">)):</span>
            <span class="c1"># get json text and translate</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;...File type detected as json&#39;</span><span class="p">)</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_id</span><span class="p">,</span> <span class="s2">&quot;manifest.json&quot;</span><span class="p">))</span>
            <span class="n">jdata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
            <span class="n">jtext</span> <span class="o">=</span> <span class="n">getText_json</span><span class="p">(</span><span class="n">jdata</span><span class="p">,</span> <span class="s1">&#39;__text&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">jtext</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">jtext</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">all_text</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">text</span>
                    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;........ Unable to extract json text&#39;</span><span class="p">)</span>
                        <span class="n">all_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;jtext empty&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No json/ecml file detected&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ETT_NOT_PERFORMED&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ETT_STOP&quot;</span><span class="p">)</span>
    <span class="n">text_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">all_text</span><span class="p">,</span> <span class="s2">&quot;plugin_used&quot;</span><span class="p">:</span> <span class="n">plugin_used</span><span class="p">,</span> <span class="s1">&#39;num_stage&#39;</span><span class="p">:</span> <span class="n">num_stages</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">text_dict</span></div>


<div class="viewcode-block" id="multimodal_text_enrichment"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.multimodal_text_enrichment">[docs]</a><span class="k">def</span> <span class="nf">multimodal_text_enrichment</span><span class="p">(</span>
        <span class="n">index</span><span class="p">,</span>
        <span class="n">timestr</span><span class="p">,</span>
        <span class="n">content_meta</span><span class="p">,</span>
        <span class="n">content_type</span><span class="p">,</span>
        <span class="n">content_to_text_path</span><span class="p">,</span>
        <span class="n">GOOGLE_APPLICATION_CREDENTIALS</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A custom function to extract text from a given</span>
<span class="sd">    Content id in a Content meta dataframe extracted using Content V2 api</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    :param index(int): row id for the Content</span>
<span class="sd">    :param content_meta(dataframe): A dataframe of Content metadata.</span>
<span class="sd">     Mandatory fields for content_meta are ``[&#39;artifactUrl&#39;, &#39;content_type&#39;,&#39;downloadUrl&#39;,</span>
<span class="sd">     &#39;gradeLevel&#39;, &#39;identifier&#39;,&#39;keywords&#39;,</span>
<span class="sd">     &#39;language&#39;, &#39;subject&#39;]``</span>
<span class="sd">    :param content_type(str): Can be ``youtube, pdf, ecml, unknown``</span>
<span class="sd">    :param content_to_text_path(str): path to save the extracted text</span>

<span class="sd">    :returns: Path where text is saved</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">type_of_url</span> <span class="o">=</span> <span class="n">content_meta</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s2">&quot;derived_contentType&quot;</span><span class="p">]</span>
    <span class="n">id_name</span> <span class="o">=</span> <span class="n">content_meta</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
    <span class="n">downloadField</span> <span class="o">=</span> <span class="n">content_type</span><span class="p">[</span><span class="n">type_of_url</span><span class="p">][</span><span class="s2">&quot;contentDownloadField&quot;</span><span class="p">]</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">content_meta</span><span class="p">[</span><span class="n">downloadField</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MTT_START_FOR_INDEX </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MTT_START_FOR_CID </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_name</span><span class="p">))</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MTT_START_FOR_URL </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
    <span class="c1"># start text extraction pipeline:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">path_to_id</span> <span class="o">=</span> <span class="n">download_to_local</span><span class="p">(</span>
            <span class="n">type_of_url</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">content_to_text_path</span><span class="p">,</span> <span class="n">id_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;path_to_id&quot;</span><span class="p">,</span> <span class="n">path_to_id</span><span class="p">)</span>
        <span class="n">path_to_assets</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_id</span><span class="p">,</span> <span class="s2">&quot;assets&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">type_of_url</span> <span class="o">!=</span> <span class="s2">&quot;pdf&quot;</span><span class="p">:</span>
            <span class="n">path_to_audio</span> <span class="o">=</span> <span class="n">video_to_speech</span><span class="p">(</span>
                <span class="n">content_type</span><span class="p">[</span><span class="n">type_of_url</span><span class="p">][</span><span class="s2">&quot;video_to_speech&quot;</span><span class="p">],</span>
                <span class="n">path_to_assets</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">path_to_audio</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">findFiles</span><span class="p">(</span><span class="n">path_to_assets</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;mp3&quot;</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">audio</span> <span class="o">=</span> <span class="n">AudioSegment</span><span class="o">.</span><span class="n">from_mp3</span><span class="p">(</span><span class="n">findFiles</span><span class="p">(</span><span class="n">path_to_assets</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;mp3&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">textExtraction_pipeline</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">speech_to_text</span><span class="p">,</span>
             <span class="p">(</span><span class="n">content_type</span><span class="p">[</span><span class="n">type_of_url</span><span class="p">][</span><span class="s2">&quot;speech_to_text&quot;</span><span class="p">],</span>
              <span class="n">path_to_assets</span><span class="p">,</span> <span class="n">GOOGLE_APPLICATION_CREDENTIALS</span><span class="p">)),</span>
            <span class="p">(</span><span class="n">image_to_text</span><span class="p">,</span>
             <span class="p">(</span><span class="n">content_type</span><span class="p">[</span><span class="n">type_of_url</span><span class="p">][</span><span class="s2">&quot;image_to_text&quot;</span><span class="p">],</span>
              <span class="n">path_to_assets</span><span class="p">)),</span>
            <span class="p">(</span><span class="n">pdf_to_text</span><span class="p">,</span>
             <span class="p">(</span><span class="n">content_type</span><span class="p">[</span><span class="n">type_of_url</span><span class="p">][</span><span class="s2">&quot;pdf_to_text&quot;</span><span class="p">],</span>
              <span class="n">path_to_assets</span><span class="p">,</span>
              <span class="n">url</span><span class="p">)),</span>
            <span class="p">(</span><span class="n">ecml_index_to_text</span><span class="p">,</span>
             <span class="p">(</span><span class="n">content_type</span><span class="p">[</span><span class="n">type_of_url</span><span class="p">][</span><span class="s2">&quot;ecml_index_to_text&quot;</span><span class="p">],</span>
              <span class="n">path_to_id</span><span class="p">))]</span>
        <span class="n">path_to_transcript</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_id</span><span class="p">,</span> <span class="s2">&quot;enriched_text.txt&quot;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">param_tuple</span> <span class="ow">in</span> <span class="n">textExtraction_pipeline</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">param_tuple</span><span class="p">)[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
        <span class="c1"># Adding description and title to the text only for PDF content</span>
        <span class="c1"># if type_of_url == &quot;pdf&quot;:</span>
        <span class="c1">#     text += content_meta[&quot;name&quot;].iloc[index] + &quot; &quot; + content_meta[&quot;description&quot;].iloc[index]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_id</span><span class="p">)</span> <span class="ow">and</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_transcript</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myTextFile</span><span class="p">:</span>
                <span class="n">myTextFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="c1"># num_of_PDFpages = pdf_to_text(&quot;none&quot;, path_to_assets, url)[&quot;no_of_pages&quot;]</span>
        <span class="c1"># Reading pdata</span>
        <span class="n">airflow_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;AIRFLOW_HOME&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/airflow&#39;</span><span class="p">))</span>
        <span class="n">dag_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">airflow_home</span><span class="p">,</span> <span class="s1">&#39;dags&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AIRFLOW_HOME: &quot;</span><span class="p">,</span> <span class="n">dag_location</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dag_location</span><span class="p">,</span> <span class="s1">&#39;graph_location&#39;</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="n">pdata</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># estimating ets:</span>
        <span class="n">epoch_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestr</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">))</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="n">content_meta</span><span class="p">[</span><span class="s2">&quot;subject&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">graph_id</span> <span class="o">=</span> <span class="n">content_meta</span><span class="p">[</span><span class="s2">&quot;graph_id&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">object_type</span> <span class="o">=</span> <span class="n">content_meta</span><span class="p">[</span><span class="s2">&quot;objectType&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">node_type</span> <span class="o">=</span> <span class="n">content_meta</span><span class="p">[</span><span class="s2">&quot;nodeType&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">node_graph_id</span> <span class="o">=</span> <span class="n">content_meta</span><span class="p">[</span><span class="s2">&quot;node_id&quot;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">plugin_used</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">num_of_stages</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># only for type ecml</span>
        <span class="k">if</span> <span class="n">type_of_url</span> <span class="o">==</span> <span class="s2">&quot;ecml&quot;</span><span class="p">:</span>
            <span class="n">plugin_used</span> <span class="o">=</span> <span class="n">ecml_index_to_text</span><span class="p">(</span><span class="s2">&quot;parse&quot;</span><span class="p">,</span> <span class="n">path_to_id</span><span class="p">)[</span><span class="s2">&quot;plugin_used&quot;</span><span class="p">]</span>
            <span class="n">num_of_stages</span> <span class="o">=</span> <span class="n">ecml_index_to_text</span><span class="p">(</span><span class="s2">&quot;parse&quot;</span><span class="p">,</span> <span class="n">path_to_id</span><span class="p">)[</span><span class="s2">&quot;num_stage&quot;</span><span class="p">]</span>

      
        
        <span class="n">mnt_output_dict_new</span> <span class="o">=</span>  <span class="p">{</span> <span class="s2">&quot;ets&quot;</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">epoch_time</span><span class="p">),</span> <span class="c1"># Event generation time in epoch</span>
                                <span class="s2">&quot;nodeUniqueId&quot;</span> <span class="p">:</span> <span class="n">id_name</span><span class="p">,</span> <span class="c1"># content id</span>
                                <span class="s2">&quot;operationType&quot;</span><span class="p">:</span> <span class="s2">&quot;UPDATE&quot;</span><span class="p">,</span> <span class="c1"># default to UPDATE</span>
                                <span class="s2">&quot;nodeType&quot;</span><span class="p">:</span> <span class="n">node_type</span><span class="p">,</span> <span class="c1"># default to DATA_NODE</span>
                                <span class="s2">&quot;graphId&quot;</span><span class="p">:</span> <span class="n">graph_id</span><span class="p">,</span> <span class="c1"># default to domain</span>
                                <span class="s2">&quot;objectType&quot;</span><span class="p">:</span> <span class="n">object_type</span><span class="p">,</span> <span class="c1"># object type - content, worksheet, textbook, collection etc</span>
                                <span class="s2">&quot;nodeGraphId&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">node_graph_id</span><span class="p">),</span> <span class="c1"># default to 0</span>
                                <span class="s2">&quot;transactionData&quot;</span> <span class="p">:</span> <span class="p">{</span>
                                    <span class="s2">&quot;properties&quot;</span> <span class="p">:</span> <span class="p">{</span>
                                        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{</span>
                                            <span class="s2">&quot;system_contentType&quot;</span><span class="p">:</span> <span class="n">type_of_url</span><span class="p">,</span> <span class="c1"># can be &quot;youtube&quot;, &quot;ecml&quot;, &quot;pdf&quot;</span>
                                            <span class="s2">&quot;system_medium&quot;</span><span class="p">:</span> <span class="n">language_detection</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="c1"># generated using google language detection api</span>
                                            <span class="s2">&quot;duration&quot;</span><span class="p">:</span> <span class="p">{</span>
                                                <span class="s2">&quot;video&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="c1"># video duration in seconds</span>
                                                <span class="s2">&quot;stage&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="c1"># can be derived from usage data</span>
                                            <span class="p">},</span>
                                            <span class="s2">&quot;num_stage&quot;</span> <span class="p">:</span> <span class="n">num_of_stages</span><span class="p">,</span> <span class="c1"># pdf: number of pages, ecml:number of stages, video:1</span>
                                            <span class="s2">&quot;system_plugins&quot;</span> <span class="p">:</span> <span class="n">plugin_used</span><span class="p">,</span> <span class="c1"># ids of plugin used in Content</span>
                                            <span class="s2">&quot;system_templates&quot;</span> <span class="p">:</span> <span class="n">template</span><span class="p">,</span> <span class="c1"># ids of templates used in Content</span>
                                            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">,</span>
                                            <span class="s2">&quot;subject&quot;</span><span class="p">:</span> <span class="n">domain</span>
                                            <span class="p">},</span>
                                        <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">pdata</span><span class="p">,</span> <span class="c1"># yaml version</span>
                                        <span class="s2">&quot;uri&quot;</span><span class="p">:</span> <span class="s2">&quot;R.1.15.1&quot;</span> <span class="c1"># git commit id</span>
                                         <span class="p">}</span>
                                     <span class="p">}</span>
                                 <span class="p">}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_id</span><span class="p">,</span> <span class="s2">&quot;ML_content_info.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">info</span><span class="p">:</span>
            <span class="n">mnt_json_dump</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
                <span class="n">mnt_output_dict_new</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># sort_keys=True,</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">mnt_json_dump</span><span class="p">)</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">time_consumed</span> <span class="o">=</span> <span class="n">stop</span><span class="o">-</span><span class="n">start</span>
        <span class="n">time_consumed_minutes</span> <span class="o">=</span> <span class="n">time_consumed</span><span class="o">/</span><span class="mf">60.0</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time taken in sec for text enrichment for cid -----&gt; </span><span class="si">{0}</span><span class="s2"> : </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_name</span><span class="p">,</span> <span class="n">time_consumed</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time taken in minutes for text enrichment for cid -----&gt; </span><span class="si">{0}</span><span class="s2"> : </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_name</span><span class="p">,</span> <span class="n">time_consumed_minutes</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MTT_TRANSCRIPT_PATH_CREATED: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_to_transcript</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MTT_CONTENT_ID_READ: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_name</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MTT_STOP_FOR_URL </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;TextEnrichment failed for url:</span><span class="si">{0}</span><span class="s2"> with id:</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">id_name</span><span class="p">))</span></div>


<div class="viewcode-block" id="custom_tokenizer"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.custom_tokenizer">[docs]</a><span class="k">def</span> <span class="nf">custom_tokenizer</span><span class="p">(</span><span class="n">path_to_text_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a text file uses custom_tokenizer function</span>
<span class="sd">    to tokenise and write the tokenised words to a keywords.csv file.</span>

<span class="sd">    :param path_to_text_file(str): Location of text file to be tokenised</span>
<span class="sd">    :param path_to_text_tokens_folder(str): Location to write the tokenised words</span>

<span class="sd">    :returns: A dataframe with a ``KEYWORDS`` column that contains tokenised keywords.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_text_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">text_file</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">text_list</span> <span class="o">=</span> <span class="n">clean_text_tokens</span><span class="p">(</span><span class="n">text_file</span><span class="p">)</span>
    <span class="n">text_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">text_list</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;KEYWORDS&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">text_df</span></div>


<div class="viewcode-block" id="tagme_text"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.tagme_text">[docs]</a><span class="k">def</span> <span class="nf">tagme_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">tagme_cred</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://tagme.d4science.org/tagme/tag&quot;</span>

        <span class="n">querystring</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;lang&quot;</span><span class="p">:</span> <span class="s2">&quot;en&quot;</span><span class="p">,</span>
            <span class="s2">&quot;include_categories&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;gcube-token&quot;</span><span class="p">:</span> <span class="n">tagme_cred</span><span class="p">[</span><span class="s1">&#39;gcube_token&#39;</span><span class="p">],</span>
            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">}</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;cache-control&#39;</span><span class="p">:</span> <span class="s2">&quot;no-cache&quot;</span><span class="p">,</span>
            <span class="s1">&#39;postman-token&#39;</span><span class="p">:</span> <span class="n">tagme_cred</span><span class="p">[</span><span class="s1">&#39;postman_token&#39;</span><span class="p">]</span> 
        <span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
            <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">querystring</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">])</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span>
        <span class="n">connection_status</span> <span class="o">=</span> <span class="kc">True</span> 
    <span class="k">except</span> <span class="ne">ConnectionError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unable to establish connection with Tagme&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">connection_status</span><span class="p">:</span> 
        <span class="k">try</span><span class="p">:</span> 
            <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://tagme.d4science.org/tagme/tag&quot;</span>
            <span class="n">querystring</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;lang&quot;</span><span class="p">:</span> <span class="s2">&quot;en&quot;</span><span class="p">,</span>
                <span class="s2">&quot;include_categories&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;gcube-token&quot;</span><span class="p">:</span> <span class="n">tagme_cred</span><span class="p">[</span><span class="s1">&#39;gcube_token&#39;</span><span class="p">],</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;cache-control&#39;</span><span class="p">:</span> <span class="s2">&quot;no-cache&quot;</span><span class="p">,</span>
                <span class="s1">&#39;postman-token&#39;</span><span class="p">:</span> <span class="n">tagme_cred</span><span class="p">[</span><span class="s1">&#39;postman_token&#39;</span><span class="p">]</span> 
            <span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                <span class="s2">&quot;GET&quot;</span><span class="p">,</span>
                <span class="n">url</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">querystring</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;annotations&#39;</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tagme Failed&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="run_tagme"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.run_tagme">[docs]</a><span class="k">def</span> <span class="nf">run_tagme</span><span class="p">(</span><span class="n">path_to_text</span><span class="p">,</span> <span class="n">tagme_cred</span><span class="p">):</span>
    <span class="n">file_</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_text</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">file_</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">index_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">window_len</span> <span class="o">=</span> <span class="mi">700</span>
    <span class="n">response_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">index_count</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">index_count</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span>
            <span class="p">(</span><span class="n">index_count</span> <span class="o">+</span> <span class="n">window_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">))])</span>
        <span class="n">index_count</span> <span class="o">+=</span> <span class="n">window_len</span>
        <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">response_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tagme_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">tagme_cred</span><span class="p">))</span>
        <span class="n">response_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">response_list</span><span class="p">)</span>
        <span class="n">response_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response_df</span></div>


<div class="viewcode-block" id="get_tagme_spots"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.get_tagme_spots">[docs]</a><span class="k">def</span> <span class="nf">get_tagme_spots</span><span class="p">(</span><span class="n">path_to_text</span><span class="p">,</span> <span class="n">tagme_cred</span><span class="p">):</span>
    <span class="n">file_</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_text</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">file_</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">index_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">window_len</span> <span class="o">=</span> <span class="mi">700</span>
    <span class="n">response_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">index_count</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">words</span><span class="p">[</span><span class="n">index_count</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span>
            <span class="p">(</span><span class="n">index_count</span> <span class="o">+</span> <span class="n">window_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">))])</span>
        <span class="n">index_count</span> <span class="o">+=</span> <span class="n">window_len</span>
        <span class="n">response_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tagme_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">tagme_cred</span><span class="p">))</span>
        <span class="n">response_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">response_list</span><span class="p">)</span>
        <span class="n">response_df</span> <span class="o">=</span> <span class="n">response_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;spot&#39;</span><span class="p">)</span>
        <span class="n">response_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cleaned_keyword_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">response_df</span><span class="p">[</span><span class="s1">&#39;spot&#39;</span><span class="p">]))</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;nan&#39;</span><span class="p">]</span>
        <span class="n">cleaned_keyword_list</span> <span class="o">=</span> <span class="n">clean_string_list</span><span class="p">(</span><span class="n">cleaned_keyword_list</span><span class="p">)</span>
        <span class="n">unique_cleaned_keyword_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cleaned_keyword_list</span><span class="p">))</span>
        <span class="n">spot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">unique_cleaned_keyword_list</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">spot</span></div>


<div class="viewcode-block" id="text_token_taxonomy_intersection_keywords"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.text_token_taxonomy_intersection_keywords">[docs]</a><span class="k">def</span> <span class="nf">text_token_taxonomy_intersection_keywords</span><span class="p">(</span>
        <span class="n">text_df</span><span class="p">,</span>
        <span class="n">taxonomy_keywords_set</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">text_df</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">])]</span>
        <span class="n">common_words</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">taxonomy_keywords_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
        <span class="n">text_tax_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">common_words</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">text_tax_df</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Keywords cannot be extracted&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="tagme_taxonomy_intersection_keywords"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.tagme_taxonomy_intersection_keywords">[docs]</a><span class="k">def</span> <span class="nf">tagme_taxonomy_intersection_keywords</span><span class="p">(</span>
        <span class="n">tagme_df</span><span class="p">,</span>
        <span class="n">taxonomy_keywords_set</span><span class="p">,</span>
        <span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">spots</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">tagme_df</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">])]</span>
        <span class="n">common_words</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">taxonomy_keywords_set</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">spots</span><span class="p">))</span>
        <span class="n">tagme_tax_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">common_words</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">tagme_tax_df</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Keywords cannot be extracted&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="getTaxonomy"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.getTaxonomy">[docs]</a><span class="k">def</span> <span class="nf">getTaxonomy</span><span class="p">(</span><span class="n">DBpedia_cat</span><span class="p">):</span>
    <span class="n">sparql</span> <span class="o">=</span> <span class="n">SPARQLWrapper</span><span class="p">(</span><span class="s2">&quot;http://dbpedia.org/sparql&quot;</span><span class="p">)</span>
    <span class="n">sparql</span><span class="o">.</span><span class="n">setQuery</span><span class="p">(</span><span class="s2">&quot;select ?value where { &lt;http://dbpedia.org/resource/Category:&quot;</span><span class="o">+</span><span class="n">DBpedia_cat</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;&gt; skos:broader{0,4} ?value }&quot;</span><span class="p">)</span>
    <span class="n">sparql</span><span class="o">.</span><span class="n">setReturnFormat</span><span class="p">(</span><span class="n">JSON</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">sparql</span><span class="o">.</span><span class="n">query</span><span class="p">()</span><span class="o">.</span><span class="n">convert</span><span class="p">()</span>
        <span class="n">dbpedia_prefix_cat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">][</span><span class="s2">&quot;bindings&quot;</span><span class="p">]:</span>
            <span class="n">dbpedia_prefix_cat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])))</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="n">dbpedia_prefix_cat</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">dbpedia_prefix_cat</span><span class="p">)</span></div>


<div class="viewcode-block" id="checkSubject"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.checkSubject">[docs]</a><span class="k">def</span> <span class="nf">checkSubject</span><span class="p">(</span><span class="n">dbpedia_prefix_cat</span><span class="p">,</span> <span class="n">subject</span><span class="p">):</span>
    <span class="n">subject_paths</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;http://dbpedia.org/resource/Category:&#39;</span><span class="o">+</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subject</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dbpedia_prefix_cat</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subject_paths</span><span class="p">])))</span></div>


<div class="viewcode-block" id="checkSubjectPartial"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.checkSubjectPartial">[docs]</a><span class="k">def</span> <span class="nf">checkSubjectPartial</span><span class="p">(</span><span class="n">dbpedia_prefix_cat</span><span class="p">,</span> <span class="n">subject</span><span class="p">):</span>
    <span class="n">subject_paths</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;http://dbpedia.org/resource/Category:&#39;</span><span class="o">+</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subject</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="nb">any</span><span class="p">([</span><span class="mi">1</span> <span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="ow">in</span> <span class="n">j</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dbpedia_prefix_cat</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subject_paths</span><span class="p">])))</span></div>


<div class="viewcode-block" id="keyword_filter"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.keyword_filter">[docs]</a><span class="k">def</span> <span class="nf">keyword_filter</span><span class="p">(</span><span class="n">tagme_response_df</span><span class="p">,</span> <span class="n">cache_cred</span><span class="p">,</span> <span class="n">path_to_category_lookup</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">update_corpus</span><span class="p">,</span> <span class="n">filter_score_val</span><span class="p">,</span> <span class="n">num_keywords</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;subject:&quot;</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">cache_cred</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">cache_status</span><span class="o">=</span><span class="kc">True</span> 
    <span class="k">except</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span><span class="o">=</span><span class="n">redis</span><span class="o">.</span><span class="n">redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">cache_cred</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">],</span> <span class="n">port</span><span class="o">=</span><span class="n">cache_cred</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">])</span>
            <span class="n">r</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
            <span class="n">cache_cred</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
            <span class="n">cache_status</span><span class="o">=</span><span class="kc">True</span> 
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unable to establish connection with redis cache.&quot;</span><span class="p">)</span>

    <span class="n">keyword_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;keyword&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;dbpedia_score&#39;</span><span class="p">:</span> <span class="p">[]})</span>
    <span class="k">if</span> <span class="n">cache_status</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tagme_response_df</span><span class="p">)):</span>
            <span class="n">keyword</span> <span class="o">=</span> <span class="n">tagme_response_df</span><span class="p">[</span><span class="s1">&#39;spot&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">score</span><span class="o">=</span><span class="n">getRediskey</span><span class="p">(</span><span class="n">subject</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="n">keyword</span><span class="p">,</span> <span class="n">cache_cred</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">],</span> <span class="n">cache_cred</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span> <span class="n">cache_cred</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">score</span><span class="p">:</span>
                <span class="n">score_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;keyword&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">keyword</span><span class="p">],</span> <span class="s1">&#39;dbpedia_score&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">score</span><span class="p">]})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># need to change:-</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_category_lookup</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
                    <span class="n">subject_ls</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stream</span><span class="p">)[</span><span class="n">subject</span><span class="p">]</span>
                <span class="n">dbpedia_categories</span> <span class="o">=</span> <span class="n">tagme_response_df</span><span class="p">[</span><span class="s1">&#39;dbpedia_categories&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">dbpedia_categories</span><span class="p">:</span>
                        <span class="n">dbpedia_prefix_cat</span> <span class="o">=</span> <span class="n">getTaxonomy</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="n">checkSubject</span><span class="p">(</span><span class="n">dbpedia_prefix_cat</span><span class="p">,</span> <span class="n">subject_ls</span><span class="p">)</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="n">status</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dbpedia_categories</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">relatedness</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">count</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dbpedia_categories</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">relatedness</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                    <span class="n">relatedness</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">score_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;keyword&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">keyword</span><span class="p">],</span> <span class="s1">&#39;dbpedia_score&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">relatedness</span><span class="p">]})</span>
            <span class="n">keyword_df</span> <span class="o">=</span> <span class="n">keyword_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score_df</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># preprocessing</span>
    <span class="n">keyword_df</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">((</span><span class="n">keyword_df</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">]))</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;nan&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">update_corpus</span><span class="p">:</span>
            <span class="n">corpus_update_df</span> <span class="o">=</span> <span class="n">keyword_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="s1">&#39;keyword&#39;</span><span class="p">)</span>
            <span class="n">corpus_update_df</span> <span class="o">=</span> <span class="n">corpus_update_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">corpus_update_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">setRediskey</span><span class="p">(</span><span class="n">subject</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="n">val</span><span class="p">[</span><span class="s1">&#39;keyword&#39;</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="s1">&#39;dbpedia_score&#39;</span><span class="p">],</span> <span class="n">cache_cred</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">],</span> <span class="n">cache_cred</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span> <span class="n">cache_cred</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])</span>          
    <span class="k">if</span> <span class="n">filter_score_val</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">keyword_df</span> <span class="o">=</span> <span class="n">keyword_df</span><span class="p">[</span><span class="n">keyword_df</span><span class="p">[</span><span class="s1">&#39;dbpedia_score&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nb">float</span><span class="p">(</span><span class="n">filter_score_val</span><span class="p">)]</span>  <span class="c1">### from yaml#filtered_keyword_df</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Invalid filter_score_val. Unable to filter. &quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_keywords</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">keyword_df</span> <span class="o">=</span> <span class="n">keyword_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;dbpedia_score&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">])</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">num_keywords</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Invalid num_keywords. Unable to filter. &quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">keyword_df</span></div>


<div class="viewcode-block" id="keyword_extraction_parallel"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.keyword_extraction_parallel">[docs]</a><span class="k">def</span> <span class="nf">keyword_extraction_parallel</span><span class="p">(</span>
        <span class="nb">dir</span><span class="p">,</span>
        <span class="n">timestr</span><span class="p">,</span>
        <span class="n">content_to_text_path</span><span class="p">,</span>
        <span class="n">extract_keywords</span><span class="p">,</span>
        <span class="n">filter_criteria</span><span class="p">,</span>
        <span class="n">cache_cred</span><span class="p">,</span>
        <span class="n">path_to_category_lookup</span><span class="p">,</span>
        <span class="n">update_corpus</span><span class="p">,</span>
        <span class="n">filter_score_val</span><span class="p">,</span>
        <span class="n">num_keywords</span><span class="p">,</span>
        <span class="n">tagme_cred</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A custom function to parallelly extract keywords</span>
<span class="sd">    for all the Content texts in a folder.</span>
<span class="sd">    This is run typically after multimodal_text_enrichment.</span>
<span class="sd">    Part of Content enrichment pipeline.</span>
<span class="sd">    The funtion allows keyword extraction using TAGME or</span>
<span class="sd">    tokenising the words using nltk tokeniser.</span>

<span class="sd">    The extracted keywords can be filtered based on following criteria:</span>

<span class="sd">        - taxonomy: if the word is a taxonomy keyword</span>

<span class="sd">        - dbpedia: if the keyword is domain keyword based on dbpedia criteria</span>
<span class="sd">        (occurs under the domain ontolgy in wikipedia)</span>

<span class="sd">        - none</span>

<span class="sd">    :param dir(str): Name of the folder containing enriched_text.txt file inside it.</span>
<span class="sd">    :param content_to_text_path(str): Path to directory containing multiple Content id folders.</span>
<span class="sd">    :param taxonomy(str): Path to taxonomy file(csv)</span>
<span class="sd">    :param extract_keywords(str): can be ``tagme`` or ``text_token``</span>
<span class="sd">    :param filter_criteria(str): can be ``taxonomy`` or ``none``</span>

<span class="sd">    :returns: Path to extracted keywords.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*******dir*********:&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***Extract keywords***:&quot;</span><span class="p">,</span> <span class="n">extract_keywords</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***Filter criteria:***&quot;</span><span class="p">,</span> <span class="n">filter_criteria</span><span class="p">)</span>
    <span class="n">path_to_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content_to_text_path</span><span class="p">,</span> <span class="nb">dir</span><span class="p">)</span>
    <span class="n">content_info_json_loc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_id</span><span class="p">,</span> <span class="s2">&quot;ML_content_info.json&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">content_info_json_loc</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">content_info_json_loc</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_loc</span><span class="p">:</span>
            <span class="n">content_info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_loc</span><span class="p">)</span>
        <span class="c1"># subject = content_info[&quot;domain&quot;]</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="n">content_info</span><span class="p">[</span><span class="s2">&quot;transactionData&quot;</span><span class="p">][</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;tags&quot;</span><span class="p">][</span><span class="s2">&quot;subject&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subject of the id: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">subject</span><span class="p">))</span>
    <span class="n">path_to_cid_transcript</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">path_to_id</span><span class="p">,</span> <span class="s2">&quot;enriched_text.txt&quot;</span><span class="p">)</span>
    <span class="n">path_to_saved_keywords</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">path_to_keywords</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">content_to_text_path</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="s2">&quot;keywords&quot;</span><span class="p">,</span> <span class="n">extract_keywords</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">filter_criteria</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path_to_cid_transcript</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Transcript present for cid: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">dir</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">path_to_cid_transcript</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path_to_keywords</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Path to transcripts &quot;</span><span class="p">,</span> <span class="n">path_to_cid_transcript</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running keyword extraction for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">path_to_cid_transcript</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">extract_keywords</span> <span class="o">==</span> <span class="s2">&quot;tagme&quot;</span> <span class="ow">and</span> <span class="n">filter_criteria</span> <span class="o">==</span> <span class="s2">&quot;dbpedia&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tagme keyword extraction is running for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">path_to_cid_transcript</span><span class="p">))</span>
                    <span class="n">tagme_response_df</span> <span class="o">=</span> <span class="n">run_tagme</span><span class="p">(</span><span class="n">path_to_cid_transcript</span><span class="p">,</span> <span class="n">tagme_cred</span><span class="p">)</span>
                    <span class="n">keyword_filter_df</span> <span class="o">=</span> <span class="n">keyword_filter</span><span class="p">(</span><span class="n">tagme_response_df</span><span class="p">,</span> <span class="n">cache_cred</span><span class="p">,</span> <span class="n">path_to_category_lookup</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">update_corpus</span><span class="p">,</span> <span class="n">filter_score_val</span><span class="p">,</span> <span class="n">num_keywords</span><span class="p">)</span>
                    <span class="n">path_to_saved_keywords</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_keywords</span><span class="p">,</span> <span class="s2">&quot;keywords.csv&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;keyword_filter_df:&quot;</span><span class="p">,</span> <span class="n">keyword_filter_df</span><span class="p">)</span>
                    <span class="n">keyword_filter_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_to_saved_keywords</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">extract_keywords</span> <span class="o">==</span> <span class="s2">&quot;tagme&quot;</span> <span class="ow">and</span> <span class="n">filter_criteria</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tagme keyword extraction is running for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">path_to_cid_transcript</span><span class="p">))</span>
                    <span class="n">tagme_df</span> <span class="o">=</span> <span class="n">get_tagme_spots</span><span class="p">(</span><span class="n">path_to_cid_transcript</span><span class="p">,</span> <span class="n">tagme_cred</span><span class="p">)</span>
                    <span class="n">path_to_saved_keywords</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_keywords</span><span class="p">,</span> <span class="s2">&quot;keywords.csv&quot;</span><span class="p">)</span>
                    <span class="n">tagme_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_to_saved_keywords</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Path to tagme tokens is </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_to_saved_keywords</span><span class="p">))</span>

                <span class="k">elif</span> <span class="n">extract_keywords</span> <span class="o">==</span> <span class="s2">&quot;tagme&quot;</span> <span class="ow">and</span> <span class="n">filter_criteria</span> <span class="o">==</span> <span class="s2">&quot;taxonomy&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tagme intersection taxonomy keyword extraction is running for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">path_to_cid_transcript</span><span class="p">))</span>
                    <span class="n">clean_keywords</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">get_words</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">taxonomy</span><span class="p">[</span><span class="s2">&quot;Keywords&quot;</span><span class="p">]))</span>
                    <span class="n">clean_keywords</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">clean_string_list</span><span class="p">,</span> <span class="n">clean_keywords</span><span class="p">)</span>
                    <span class="n">flat_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="n">clean_keywords</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
                    <span class="n">taxonomy_keywords_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">cleantext</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flat_list</span><span class="p">])</span>
                    <span class="n">tagme_df</span> <span class="o">=</span> <span class="n">get_tagme_spots</span><span class="p">(</span><span class="n">path_to_cid_transcript</span><span class="p">,</span> <span class="n">tagme_cred</span><span class="p">)</span>
                    <span class="n">path_to_saved_keywords</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_keywords</span><span class="p">,</span> <span class="s2">&quot;keywords.csv&quot;</span><span class="p">)</span>
                    <span class="n">tagme_taxonomy_df</span> <span class="o">=</span> <span class="n">tagme_taxonomy_intersection_keywords</span><span class="p">(</span>
                        <span class="n">tagme_df</span><span class="p">,</span> <span class="n">taxonomy_keywords_set</span><span class="p">)</span>
                    <span class="n">tagme_taxonomy_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_to_saved_keywords</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Path to tagme taxonomy intersection tokens is </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">path_to_saved_keywords</span><span class="p">))</span>

                <span class="k">elif</span> <span class="n">extract_keywords</span> <span class="o">==</span> <span class="s2">&quot;text_token&quot;</span> <span class="ow">and</span> <span class="n">filter_criteria</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Text tokens extraction running for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">path_to_cid_transcript</span><span class="p">))</span>
                    <span class="n">text_df</span> <span class="o">=</span> <span class="n">custom_tokenizer</span><span class="p">(</span>
                        <span class="n">path_to_cid_transcript</span><span class="p">)</span>
                    <span class="n">path_to_saved_keywords</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_keywords</span><span class="p">,</span> <span class="s2">&quot;keywords.csv&quot;</span><span class="p">)</span>
                    <span class="n">text_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_to_saved_keywords</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Path to text tokens is </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">path_to_saved_keywords</span><span class="p">))</span>

                <span class="k">elif</span> <span class="n">extract_keywords</span> <span class="o">==</span> <span class="s2">&quot;text_token&quot;</span> <span class="ow">and</span> <span class="n">filter_criteria</span> <span class="o">==</span> <span class="s2">&quot;taxonomy&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Text tokens intersection taxonomy running for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">path_to_cid_transcript</span><span class="p">))</span>
                    <span class="n">text_df</span> <span class="o">=</span> <span class="n">custom_tokenizer</span><span class="p">(</span>
                        <span class="n">path_to_cid_transcript</span><span class="p">)</span>
                    <span class="n">clean_keywords</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">get_words</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">taxonomy</span><span class="p">[</span><span class="s2">&quot;Keywords&quot;</span><span class="p">]))</span>
                    <span class="n">clean_keywords</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">clean_string_list</span><span class="p">,</span> <span class="n">clean_keywords</span><span class="p">)</span>
                    <span class="n">flat_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="n">clean_keywords</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
                    <span class="n">taxonomy_keywords_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">cleantext</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">flat_list</span><span class="p">])</span>
                    <span class="n">text_tax_df</span> <span class="o">=</span> <span class="n">text_token_taxonomy_intersection_keywords</span><span class="p">(</span>
                        <span class="n">text_df</span><span class="p">,</span> <span class="n">taxonomy_keywords_set</span><span class="p">)</span>
                    <span class="n">path_to_saved_keywords</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_keywords</span><span class="p">,</span> <span class="s2">&quot;keywords.csv&quot;</span><span class="p">)</span>
                    <span class="n">text_tax_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path_to_saved_keywords</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Path to text tokens intersection taxonomy is </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">path_to_saved_keywords</span><span class="p">))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid argument provided&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The text file </span><span class="si">{0}</span><span class="s2"> has no contents&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">path_to_cid_transcript</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Raise exception for </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_to_cid_transcript</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Raise exception for </span><span class="si">{0}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path_to_cid_transcript</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Transcripts doesnt exist for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">path_to_cid_transcript</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">path_to_saved_keywords</span><span class="p">:</span>
        <span class="n">keywords_dpediaScore</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_saved_keywords</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">keywords_dpediaScore</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Reading pdata:</span>
    <span class="n">airflow_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;AIRFLOW_HOME&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~/airflow&#39;</span><span class="p">))</span>
    <span class="n">dag_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">airflow_home</span><span class="p">,</span> <span class="s1">&#39;dags&#39;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dag_location</span><span class="p">,</span> <span class="s1">&#39;graph_location&#39;</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">pdata</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AIRFLOW_HOME: &quot;</span><span class="p">,</span> <span class="n">dag_location</span><span class="p">)</span>
    <span class="c1"># estimating ets:</span>
    <span class="n">epoch_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">timestr</span><span class="p">,</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-%H%M%S&quot;</span><span class="p">))</span>
    <span class="n">kep_output_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;ets&#39;</span><span class="p">:</span>  <span class="nb">int</span><span class="p">(</span><span class="n">epoch_time</span><span class="p">),</span>
                        <span class="s1">&#39;keywords&#39;</span><span class="p">:</span> <span class="n">keywords_dpediaScore</span><span class="p">,</span>
                        <span class="s2">&quot;pdata&quot;</span><span class="p">:</span> <span class="n">pdata</span><span class="p">,</span>
                        <span class="s2">&quot;commit_id&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
                        <span class="p">}</span>
    <span class="n">kep_output_dict_new</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;ets&quot;</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">epoch_time</span><span class="p">),</span> <span class="c1">#Event generation time in epoch</span>
                            <span class="s2">&quot;transactionData&quot;</span> <span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;properties&quot;</span> <span class="p">:</span> <span class="p">{</span>
                                    <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">{</span>
                                        <span class="s2">&quot;system_keywords&quot;</span><span class="p">:</span> <span class="n">keywords_dpediaScore</span><span class="p">,</span>
                                        <span class="p">},</span>
                                    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">pdata</span><span class="p">,</span> <span class="c1">#yaml version</span>
                                    <span class="s2">&quot;uri&quot;</span><span class="p">:</span> <span class="s2">&quot;R.1.15.1&quot;</span>
                                     <span class="p">}</span>
                                <span class="p">}</span>
                           <span class="p">}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_id</span><span class="p">,</span> <span class="s2">&quot;ML_keyword_info.json&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">info</span><span class="p">:</span>
        <span class="n">kep_json_dump</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span>
            <span class="n">kep_output_dict_new</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># sort_keys=True,</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">kep_json_dump</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">content_to_text_path</span></div>


<div class="viewcode-block" id="clean_string_list"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.clean_string_list">[docs]</a><span class="k">def</span> <span class="nf">clean_string_list</span><span class="p">(</span><span class="n">x_list</span><span class="p">):</span>
    <span class="n">x_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">((</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">),</span> <span class="n">x_list</span><span class="p">))</span>
    <span class="n">x_clean</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_list</span><span class="p">]</span>
    <span class="n">x_clean</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_clean</span><span class="p">]</span>
    <span class="n">x_clean</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">x_clean</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x_clean</span></div>


<div class="viewcode-block" id="get_words"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.get_words">[docs]</a><span class="k">def</span> <span class="nf">get_words</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;nan&#39;</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>


<div class="viewcode-block" id="custom_listPreProc"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.custom_listPreProc">[docs]</a><span class="k">def</span> <span class="nf">custom_listPreProc</span><span class="p">(</span><span class="n">key_list</span><span class="p">,</span> <span class="n">preproc</span><span class="p">,</span> <span class="n">DELIMITTER</span><span class="p">):</span>
    <span class="n">key_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">clean_string_list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">key_list</span><span class="p">]</span>
    <span class="n">key_list_clean</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">key_list</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">strip_word</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">DELIMITTER</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">preproc</span> <span class="o">==</span> <span class="s1">&#39;stem_lem&#39;</span><span class="p">:</span>
            <span class="n">key_list_clean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stem_lem</span><span class="p">((</span><span class="n">x</span><span class="p">),</span> <span class="n">DELIMITTER</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unknown preproc&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">return</span> <span class="n">key_list_clean</span></div>


<div class="viewcode-block" id="stem_lem"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.stem_lem">[docs]</a><span class="k">def</span> <span class="nf">stem_lem</span><span class="p">(</span><span class="n">keyword_list</span><span class="p">,</span> <span class="n">DELIMITTER</span><span class="p">):</span>
    <span class="n">wordnet_lemmatizer</span> <span class="o">=</span> <span class="n">WordNetLemmatizer</span><span class="p">()</span>
    <span class="n">stemmer</span> <span class="o">=</span> <span class="n">PorterStemmer</span><span class="p">()</span>
    <span class="n">keyword_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">keyword_list</span><span class="p">]</span>
    <span class="n">keyword_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DELIMITTER</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keyword_list</span><span class="p">]</span>
    <span class="n">lemma_ls_1</span> <span class="o">=</span> <span class="p">[[</span><span class="n">wordnet_lemmatizer</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">(</span>
        <span class="n">item</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="s2">&quot;n&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span> <span class="k">for</span> <span class="n">words</span> <span class="ow">in</span> <span class="n">keyword_list</span><span class="p">]</span>
    <span class="n">lemma_ls_2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">wordnet_lemmatizer</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">(</span>
        <span class="n">item</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="s2">&quot;v&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span> <span class="k">for</span> <span class="n">words</span> <span class="ow">in</span> <span class="n">lemma_ls_1</span><span class="p">]</span>
    <span class="n">lemma_ls_3</span> <span class="o">=</span> <span class="p">[[</span><span class="n">wordnet_lemmatizer</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">(</span>
        <span class="n">item</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span> <span class="k">for</span> <span class="n">words</span> <span class="ow">in</span> <span class="n">lemma_ls_2</span><span class="p">]</span>
    <span class="n">lemma_ls_4</span> <span class="o">=</span> <span class="p">[[</span><span class="n">wordnet_lemmatizer</span><span class="o">.</span><span class="n">lemmatize</span><span class="p">(</span>
        <span class="n">item</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span> <span class="k">for</span> <span class="n">words</span> <span class="ow">in</span> <span class="n">lemma_ls_3</span><span class="p">]</span>
    <span class="n">stemm_ls</span> <span class="o">=</span> <span class="p">[[</span><span class="n">stemmer</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span> <span class="k">for</span> <span class="n">words</span> <span class="ow">in</span> <span class="n">lemma_ls_4</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">DELIMITTER</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stemm_ls</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_level_keywords"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.get_level_keywords">[docs]</a><span class="k">def</span> <span class="nf">get_level_keywords</span><span class="p">(</span><span class="n">taxonomy_df</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
    <span class="n">level_keyword_df</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">taxonomy_df</span><span class="p">[</span><span class="n">level</span><span class="p">])):</span>
        <span class="n">Domain_keywords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">taxonomy_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">taxonomy_df</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">==</span> <span class="n">subject</span><span class="p">,</span> <span class="s1">&#39;Keywords&#39;</span><span class="p">])</span>
        <span class="n">unique_keywords</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ind</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">Domain_keywords</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="n">level_keyword_df</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">level</span><span class="p">:</span> <span class="n">subject</span><span class="p">,</span> <span class="s1">&#39;Keywords&#39;</span><span class="p">:</span> <span class="n">unique_keywords</span><span class="p">})</span>
    <span class="n">level_keyword_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">level_keyword_df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">level_keyword_df</span></div>


<div class="viewcode-block" id="getGradedigits"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.getGradedigits">[docs]</a><span class="k">def</span> <span class="nf">getGradedigits</span><span class="p">(</span><span class="n">class_x</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Class&quot;</span><span class="p">,</span> <span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;Grade&quot;</span><span class="p">,</span> <span class="s2">&quot;grade&quot;</span><span class="p">]:</span>
        <span class="n">class_x</span> <span class="o">=</span> <span class="n">class_x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">class_x</span></div>


<div class="viewcode-block" id="match_str_list"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.match_str_list">[docs]</a><span class="k">def</span> <span class="nf">match_str_list</span><span class="p">(</span><span class="n">list1</span><span class="p">,</span> <span class="n">list2</span><span class="p">):</span>
    <span class="n">intersection</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">list2</span><span class="p">)))</span>
    <span class="n">union</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list1</span> <span class="o">+</span> <span class="n">list2</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">union</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">jaccard_index</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">/</span> <span class="n">union</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">jaccard_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cosine_similarity</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list1</span><span class="p">))</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list2</span><span class="p">)))</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="n">cosine_similarity</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">match_percent_l1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">match_percent_l1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list2</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">match_percent_l2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">match_percent_l2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;intersection&#39;</span><span class="p">:</span> <span class="n">intersection</span><span class="p">,</span>
        <span class="s1">&#39;union&#39;</span><span class="p">:</span> <span class="n">union</span><span class="p">,</span>
        <span class="s1">&#39;jaccard_index&#39;</span><span class="p">:</span> <span class="n">jaccard_index</span><span class="p">,</span>
        <span class="s1">&#39;cosine_similarity&#39;</span><span class="p">:</span> <span class="n">cosine_similarity</span><span class="p">,</span>
        <span class="s1">&#39;match_percent_l1&#39;</span><span class="p">:</span> <span class="n">match_percent_l1</span><span class="p">,</span>
        <span class="s1">&#39;match_percent_l2&#39;</span><span class="p">:</span> <span class="n">match_percent_l2</span><span class="p">}</span></div>


<div class="viewcode-block" id="normalize"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.normalize">[docs]</a><span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">norm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">v</span> <span class="o">/</span> <span class="n">norm</span></div>


<div class="viewcode-block" id="dictionary_merge"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.dictionary_merge">[docs]</a><span class="k">def</span> <span class="nf">dictionary_merge</span><span class="p">(</span><span class="n">dict_ls</span><span class="p">):</span>

    <span class="n">keys_ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">dictionary</span> <span class="ow">in</span> <span class="n">dict_ls</span><span class="p">]</span>
    <span class="n">keys_ls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">elem</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">keys_ls</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">])</span>
    <span class="n">dict_all</span> <span class="o">=</span> <span class="p">{</span><span class="n">keys</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span> <span class="k">for</span> <span class="n">keys</span> <span class="ow">in</span> <span class="p">(</span><span class="n">keys_ls</span><span class="p">)}</span>
    <span class="k">for</span> <span class="n">dictionary</span> <span class="ow">in</span> <span class="n">dict_ls</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dict_all</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_all</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dictionary</span><span class="p">[</span><span class="n">keys</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">dict_all</span></div>


<div class="viewcode-block" id="get_sorted_list"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.get_sorted_list">[docs]</a><span class="k">def</span> <span class="nf">get_sorted_list</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="n">x_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">x_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">x_df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="n">ascending</span><span class="o">=</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span></div>


<div class="viewcode-block" id="save_obj"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.save_obj">[docs]</a><span class="k">def</span> <span class="nf">save_obj</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_obj"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.load_obj">[docs]</a><span class="k">def</span> <span class="nf">load_obj</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="getPhrase"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.getPhrase">[docs]</a><span class="k">def</span> <span class="nf">getPhrase</span><span class="p">(</span><span class="n">x_list</span><span class="p">,</span> <span class="n">DELIMITTER</span><span class="p">):</span>
    <span class="c1"># x_list=clean_string_list(x_list)</span>
    <span class="n">x_phrase</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_list</span> <span class="k">if</span> <span class="n">DELIMITTER</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
    <span class="n">x_word</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">x_list</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x_phrase</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x_word</span><span class="p">,</span> <span class="n">x_phrase</span></div>


<div class="viewcode-block" id="removeShortWords"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.removeShortWords">[docs]</a><span class="k">def</span> <span class="nf">removeShortWords</span><span class="p">(</span><span class="n">mylist</span><span class="p">,</span> <span class="n">wordlen</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mylist</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">wordlen</span><span class="p">]</span></div>


<div class="viewcode-block" id="WordtoPhraseMatch"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.WordtoPhraseMatch">[docs]</a><span class="k">def</span> <span class="nf">WordtoPhraseMatch</span><span class="p">(</span><span class="n">wordlist</span><span class="p">,</span> <span class="n">phraselist</span><span class="p">,</span> <span class="n">DELIMITTER</span><span class="p">):</span>
    <span class="n">phrasewords</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DELIMITTER</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">phraselist</span><span class="p">]</span>
    <span class="n">match_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">partial_match_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">wordlist_dynamic</span> <span class="o">=</span> <span class="n">wordlist</span><span class="p">[:]</span>
    <span class="k">for</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">phrasewords</span><span class="p">:</span>
        <span class="n">word_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">wordlist</span> <span class="o">=</span> <span class="n">wordlist_dynamic</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">wordlist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">word_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">partial_match_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">word</span><span class="p">,</span> <span class="n">DELIMITTER</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">items</span><span class="p">)))</span>
                <span class="n">wordlist_dynamic</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
        <span class="n">match_count</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">word_count</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">partial_match_list</span><span class="p">,</span> <span class="n">match_count</span></div>


<div class="viewcode-block" id="jaccard_with_phrase"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.jaccard_with_phrase">[docs]</a><span class="k">def</span> <span class="nf">jaccard_with_phrase</span><span class="p">(</span><span class="n">list1</span><span class="p">,</span> <span class="n">list2</span><span class="p">):</span>
    <span class="n">DELIMITTER</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span>
    <span class="n">intersection_words</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">list1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list1</span><span class="p">))</span>
    <span class="n">list2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list2</span><span class="p">))</span>
    <span class="n">list1</span> <span class="o">=</span> <span class="n">removeShortWords</span><span class="p">(</span><span class="n">list1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">list2</span> <span class="o">=</span> <span class="n">removeShortWords</span><span class="p">(</span><span class="n">list2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">list1_words</span><span class="p">,</span> <span class="n">list1_phrases</span> <span class="o">=</span> <span class="n">getPhrase</span><span class="p">(</span><span class="n">list1</span><span class="p">,</span> <span class="n">DELIMITTER</span><span class="p">)</span>
    <span class="n">list2_words</span><span class="p">,</span> <span class="n">list2_phrases</span> <span class="o">=</span> <span class="n">getPhrase</span><span class="p">(</span><span class="n">list2</span><span class="p">,</span> <span class="n">DELIMITTER</span><span class="p">)</span>
    <span class="n">intersection</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">match_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># count matching words</span>
    <span class="n">exact_word_intersection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list1_words</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">list2_words</span><span class="p">))</span>
    <span class="n">intersection_words</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">exact_word_intersection</span><span class="p">])</span>
    <span class="n">exact_word_match</span> <span class="o">=</span> <span class="n">match_str_list</span><span class="p">(</span><span class="n">list1_words</span><span class="p">,</span> <span class="n">list2_words</span><span class="p">)[</span><span class="s1">&#39;intersection&#39;</span><span class="p">]</span>
    <span class="n">intersection</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">+</span> <span class="n">exact_word_match</span>
    <span class="n">match_count</span> <span class="o">+=</span> <span class="n">exact_word_match</span>
    <span class="n">phraselist1</span> <span class="o">=</span> <span class="n">list1_phrases</span>
    <span class="n">phraselist2</span> <span class="o">=</span> <span class="n">list2_phrases</span>
    <span class="n">exact_phrase_intersection</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">phrase1</span> <span class="ow">in</span> <span class="n">phraselist1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">phrase2</span> <span class="ow">in</span> <span class="n">phraselist2</span><span class="p">:</span>
            <span class="k">if</span><span class="p">((</span><span class="n">phrase2</span> <span class="ow">in</span> <span class="n">phrase1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">phrase1</span> <span class="ow">in</span> <span class="n">phrase2</span><span class="p">)):</span>
                <span class="n">exact_phrase_intersection</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">phrase1</span><span class="p">,</span> <span class="n">phrase2</span><span class="p">))</span>
                <span class="n">list2_phrases</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">phrase2</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="n">exact_phrase_length</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
        <span class="p">[</span><span class="nb">min</span><span class="p">([(</span><span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">DELIMITTER</span><span class="p">)))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">exact_phrase_intersection</span><span class="p">])</span>
    <span class="n">intersection</span> <span class="o">+=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">exact_phrase_length</span><span class="p">)</span>
    <span class="n">match_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">exact_phrase_intersection</span><span class="p">)</span>
    <span class="n">intersection_words</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">exact_phrase_intersection</span><span class="p">)</span>
    <span class="n">non_matched_list1_words</span><span class="p">,</span> <span class="n">non_matched_list2_words</span> <span class="o">=</span> <span class="n">list1_words</span><span class="p">,</span> <span class="n">list2_words</span>
    <span class="n">non_matched_list1_phrases</span><span class="p">,</span> <span class="n">non_matched_list2_phrases</span> <span class="o">=</span> <span class="n">list1_phrases</span><span class="p">,</span> <span class="n">list2_phrases</span>
    <span class="k">if</span> <span class="n">exact_word_intersection</span><span class="p">:</span>
        <span class="n">non_matched_list1_words</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">list1_words</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exact_word_intersection</span><span class="p">]</span>
        <span class="n">non_matched_list2_words</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">list2_words</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exact_word_intersection</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">exact_phrase_intersection</span><span class="p">:</span>
        <span class="n">non_matched_list1_phrases</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">word</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">exact_phrase_intersection</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">non_matched_list1_phrases</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">word</span><span class="p">]</span>
        <span class="n">non_matched_list2_phrases</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">word</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">exact_phrase_intersection</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">non_matched_list2_phrases</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">word</span><span class="p">]</span>
    <span class="n">partial_match_list1</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">WordtoPhraseMatch</span><span class="p">(</span>
        <span class="n">non_matched_list1_words</span><span class="p">,</span> <span class="n">non_matched_list2_phrases</span><span class="p">,</span> <span class="n">DELIMITTER</span><span class="p">)</span>
    <span class="n">match_count</span> <span class="o">+=</span> <span class="n">count</span>
    <span class="k">if</span> <span class="n">partial_match_list1</span><span class="p">:</span>
        <span class="n">non_matched_list1_words</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">word</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">partial_match_list1</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">non_matched_list1_words</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">word</span><span class="p">]</span>
        <span class="n">non_matched_list2_phrases</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">word</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">partial_match_list1</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">non_matched_list2_phrases</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">word</span><span class="p">]</span>
    <span class="n">intersection</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">partial_match_list1</span><span class="p">)</span>
    <span class="n">intersection_words</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">partial_match_list1</span><span class="p">)</span>
    <span class="c1"># Content phrase to taxonomy words</span>
    <span class="n">partial_match_list2</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">WordtoPhraseMatch</span><span class="p">(</span>
        <span class="n">non_matched_list2_words</span><span class="p">,</span> <span class="n">non_matched_list1_phrases</span><span class="p">,</span> <span class="n">DELIMITTER</span><span class="p">)</span>
    <span class="n">match_count</span> <span class="o">+=</span> <span class="n">count</span>
    <span class="n">non_matched_list2_words</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">partial_match_list2</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">non_matched_list1_phrases</span><span class="p">]</span>
    <span class="n">intersection</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">partial_match_list2</span><span class="p">)</span>
    <span class="n">intersection_words</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">partial_match_list2</span><span class="p">)</span>
    <span class="n">intersection_words</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">intersection_words</span> <span class="k">if</span> <span class="n">el</span> <span class="o">!=</span> <span class="p">[]]</span>

    <span class="k">if</span> <span class="p">(((</span><span class="nb">len</span><span class="p">(</span><span class="n">list2</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">list1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">list2</span><span class="p">)</span> <span class="o">-</span> <span class="n">match_count</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;jaccard&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">list2</span><span class="p">)</span> <span class="o">-</span> <span class="n">match_count</span><span class="p">),</span>
                <span class="s1">&#39;match_percentage&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list2</span><span class="p">)),</span>
                <span class="s1">&#39;word_intersection&#39;</span><span class="p">:</span> <span class="n">intersection_words</span><span class="p">}</span>
    <span class="k">elif</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">list1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">list2</span><span class="p">)</span> <span class="o">-</span> <span class="n">match_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;jaccard&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;match_percentage&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list2</span><span class="p">)),</span>
                <span class="s1">&#39;word_intersection&#39;</span><span class="p">:</span> <span class="n">intersection_words</span><span class="p">}</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;jaccard&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">intersection</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">list1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">list2</span><span class="p">)</span> <span class="o">-</span> <span class="n">match_count</span><span class="p">),</span>
            <span class="s1">&#39;match_percentage&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;word_intersection&#39;</span><span class="p">:</span> <span class="n">intersection_words</span><span class="p">}</span></div>


<div class="viewcode-block" id="precision_from_dictionary"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.precision_from_dictionary">[docs]</a><span class="k">def</span> <span class="nf">precision_from_dictionary</span><span class="p">(</span><span class="n">predicted_df</span><span class="p">,</span> <span class="n">observed_df</span><span class="p">,</span> <span class="n">window_len</span><span class="p">):</span>
    <span class="n">window</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">window_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">percent_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">window</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">predicted_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obs_tags</span> <span class="o">=</span> <span class="n">observed_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="n">pred_tags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">predicted_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cid</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">ind</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">obs_tags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">pred_tags</span><span class="p">)):</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; metadata not available&quot;</span><span class="p">)</span>
        <span class="n">percent_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">predicted_df</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">percent_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;percent&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="agg_precision_from_dictionary"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.agg_precision_from_dictionary">[docs]</a><span class="k">def</span> <span class="nf">agg_precision_from_dictionary</span><span class="p">(</span><span class="n">predicted_dct</span><span class="p">,</span> <span class="n">observed_dct</span><span class="p">,</span> <span class="n">window_len</span><span class="p">):</span>
    <span class="n">predicted_val_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">observed_val_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">observed_dct</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">predicted_df</span> <span class="o">=</span> <span class="n">predicted_dct</span><span class="p">[</span><span class="n">subject</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">predicted_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">predicted_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">predicted_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">observed_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observed_dct</span><span class="p">[</span><span class="n">subject</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">window</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">window_len</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">window_len</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predicted_val_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">observed_val_list</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="ow">in</span> <span class="n">predicted_val_list</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">predicted_val_list</span><span class="p">[</span><span class="n">ind</span><span class="p">]),</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">window</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">predicted_val_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Percent&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="CustomDateFormater"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.CustomDateFormater">[docs]</a><span class="k">def</span> <span class="nf">CustomDateFormater</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">datetime</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span>
    <span class="n">expected_args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;fileloc&#39;</span><span class="p">,</span> <span class="s1">&#39;datepattern&#39;</span><span class="p">]</span>
    <span class="n">kwargsdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">expected_args</span><span class="p">:</span>
            <span class="n">kwargsdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unexpected Argument&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargsdict</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">kwargsdict</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;today&quot;</span><span class="p">:</span>
            <span class="n">dateobj</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;yesterday&quot;</span><span class="p">:</span>
            <span class="n">dateobj</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">-</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;lastrun&quot;</span><span class="p">:</span>
            <span class="n">list_of_files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">kwargsdict</span><span class="p">[</span><span class="s1">&#39;fileloc&#39;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;/*&quot;</span><span class="p">)</span>
            <span class="n">timestr_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">list_of_files</span> <span class="k">if</span> <span class="n">is_date</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file</span><span class="p">)[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">latest_file</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">timestr_files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dateobj</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">latest_file</span><span class="p">,</span> <span class="n">kwargsdict</span><span class="p">[</span><span class="s1">&#39;datepattern&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">dateobj</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">kwargsdict</span><span class="p">[</span><span class="s1">&#39;datepattern&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
            <span class="n">dateobj</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">return</span> <span class="n">dateobj</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S.000+0530&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Require atleast 1 argument.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="findDate"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.findDate">[docs]</a><span class="k">def</span> <span class="nf">findDate</span><span class="p">(</span><span class="n">x_date</span><span class="p">,</span> <span class="n">DS_DATA_HOME</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x_date</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;today&#39;</span><span class="p">,</span> <span class="s1">&#39;yesterday&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">CustomDateFormater</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_date</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">x_date</span> <span class="o">==</span> <span class="s2">&quot;lastrun&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CustomDateFormater</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_date</span><span class="p">,</span> <span class="n">fileloc</span><span class="o">=</span><span class="n">DS_DATA_HOME</span><span class="p">,</span> <span class="n">datepattern</span><span class="o">=</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">-%H%M%S&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">CustomDateFormater</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_date</span><span class="p">,</span> <span class="n">datepattern</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%m-%Y&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="setRediskey"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.setRediskey">[docs]</a><span class="k">def</span> <span class="nf">setRediskey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function writes a key value pair into Redis cache. It is a wrapper on set operation of redis-py.</span>

<span class="sd">    :param key(str): The key.</span>
<span class="sd">    :param val(str): The value assigned to key.</span>
<span class="sd">    :param host(str): redis server host. default:&#39;localhost&#39;.</span>
<span class="sd">    :param port(str): redis server port. default: 6379&#39;.</span>
<span class="sd">    :param password(str): redis server password. default: None.</span>
<span class="sd">    :returns: The detected language for the given text.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">redis_host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">redis_port</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">redis_password</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>   
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="getRediskey"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.getRediskey">[docs]</a><span class="k">def</span> <span class="nf">getRediskey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function reads the value from Redis cache based on the key. It is a wrapper on  get operation of redis-py .</span>

<span class="sd">    :param key(str): The key.</span>
<span class="sd">    :param host(str): redis server host. default:&#39;localhost&#39;.</span>
<span class="sd">    :param port(str): redis server port. default: 6379&#39;.</span>
<span class="sd">    :param password(str): redis server password. default: None.</span>
<span class="sd">    :returns: The detected language for the given text.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">redis_host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">redis_port</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">redis_password</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>     
        <span class="k">return</span> <span class="n">msg</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="merge_json"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.merge_json">[docs]</a><span class="k">def</span> <span class="nf">merge_json</span><span class="p">(</span><span class="n">dict1</span><span class="p">,</span> <span class="n">dict2</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">path</span> <span class="o">=</span> <span class="p">[]</span>
   <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict2</span><span class="p">:</span>
       <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dict1</span><span class="p">:</span>
           <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dict1</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dict2</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
               <span class="n">merge_json</span><span class="p">(</span><span class="n">dict1</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">dict2</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)])</span>
           <span class="k">elif</span> <span class="n">dict1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">dict2</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
               <span class="k">pass</span> <span class="c1"># same leaf value</span>
           <span class="k">else</span><span class="p">:</span>
               <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Conflict at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]))</span>
       <span class="k">else</span><span class="p">:</span>
           <span class="n">dict1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict2</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
   <span class="k">return</span> <span class="n">dict1</span></div>


<div class="viewcode-block" id="writeTokafka"><a class="viewcode-back" href="../../../../../daggit.contrib.sunbird.operators.html#daggit.contrib.sunbird.operators.contentTaggingUtils.writeTokafka">[docs]</a><span class="k">def</span> <span class="nf">writeTokafka</span><span class="p">(</span><span class="n">kafka_broker</span><span class="p">):</span>
    <span class="n">connection_established</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">KafkaClient</span><span class="p">(</span><span class="n">kafka_broker</span><span class="p">)</span>
        <span class="n">server_topics</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">topic_partitions</span>
        <span class="n">connection_established</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">server_topics</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">connection_established</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Sunbird

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>